<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Prism - Document Analysis and Review Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 25%, #ec4899 50%, #f59e0b 75%, #10b981 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            background-attachment: fixed;
            color: #333;
            line-height: 1.6;
            transition: all 0.3s ease;
            min-height: 100vh;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="1" fill="%23ffffff" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            pointer-events: none;
            z-index: -1;
        }

        .container {
            max-width: 100vw;
            width: 100%;
            margin: 0;
            padding: 5px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 0;
            box-shadow: none;
            backdrop-filter: blur(10px);
            min-height: 100vh;
        }

        @media (min-width: 768px) {
            .container {
                padding: 15px;
                border-radius: 20px;
                margin: 10px auto;
                max-width: 98vw;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
                min-height: calc(100vh - 20px);
            }
        }
        
        @media (min-width: 1200px) {
            .container {
                max-width: 95vw;
                margin: 20px auto;
                padding: 20px;
            }
        }

        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 50%, #ec4899 100%);
            color: white;
            padding: 35px;
            border-radius: 20px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .header h1 {
            font-size: 2.8em;
            margin-bottom: 15px;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            animation: titleGlow 3s ease-in-out infinite alternate;
        }
        
        @keyframes titleGlow {
            from { filter: brightness(1); }
            to { filter: brightness(1.2); }
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary { background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white; }
        .btn-success { background: linear-gradient(135deg, #10b981, #059669); color: white; }
        .btn-danger { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
        .btn-info { background: linear-gradient(135deg, #06b6d4, #0891b2); color: white; }
        .btn-warning { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
        .btn-secondary { background: linear-gradient(135deg, #6b7280, #4b5563); color: white; }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            filter: brightness(1.1);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: white;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #f8f9ff;
        }

        .upload-area.dragover {
            border-color: #2ecc71;
            background: #f0fff4;
        }

        .file-input {
            display: none;
        }

        .progress-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #ecf0f1;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        .statistics {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .stat-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
            height: calc(100vh - 400px);
            min-height: 600px;
        }

        @media (min-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }
        }

        @media (min-width: 768px) and (max-width: 1023px) {
            .main-content {
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }
        }

        .panel {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .panel-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            font-size: 1.2em;
            font-weight: 500;
        }

        .panel-content {
            padding: 0;
            height: calc(100vh - 450px);
            min-height: 500px;
            max-height: 700px;
            display: flex;
            flex-direction: column;
        }

        .document-header {
            position: sticky;
            top: 0;
            background: white;
            border-bottom: 2px solid #ecf0f1;
            padding: 15px;
            z-index: 10;
        }

        .document-content-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .feedback-header {
            position: sticky;
            top: 0;
            background: white;
            border-bottom: 2px solid #ecf0f1;
            padding: 15px;
            z-index: 10;
        }

        .feedback-content-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .custom-feedback-fixed {
            position: sticky;
            bottom: 0;
            background: white;
            border-top: 2px solid #ecf0f1;
            padding: 15px;
            z-index: 10;
        }

        .section-nav {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .section-select {
            flex: 1;
            min-width: 200px;
            padding: 10px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 14px;
        }

        .risk-indicator {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
        }

        .risk-high { background: #e74c3c; color: white; }
        .risk-medium { background: #f39c12; color: white; }
        .risk-low { background: #2ecc71; color: white; }

        .feedback-item {
            background: #f8f9ff;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .feedback-item:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .feedback-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .feedback-meta {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .feedback-type {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .type-critical { background: #e74c3c; color: white; }
        .type-important { background: #f39c12; color: white; }
        .type-suggestion { background: #3498db; color: white; }

        .feedback-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .tabs {
            display: flex;
            background: #ecf0f1;
            border-radius: 10px 10px 0 0;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 10px 10px 0 0;
        }

        .tab.active {
            background: white;
            color: #667eea;
            font-weight: 600;
        }

        .tab-content {
            display: none;
            padding: 0;
            height: 560px;
            overflow-y: auto;
            background: #ffffff;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
        }

        .chat-container {
            height: 400px;
            border: 1px solid #ecf0f1;
            border-radius: 10px;
            overflow-y: auto;
            padding: 15px;
            margin-bottom: 15px;
            background: #fafafa;
        }

        .chat-message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 10px;
            max-width: 80%;
        }

        .chat-message.user {
            background: #667eea;
            color: white;
            margin-left: auto;
        }

        .chat-message.assistant {
            background: white;
            border: 1px solid #ecf0f1;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 14px;
        }

        .custom-feedback-form {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #95a5a6;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success { background: #2ecc71; }
        .notification.error { background: #e74c3c; }
        .notification.info { background: #3498db; }

        /* Dark mode styles - Absolute dark mode */
        body.dark-mode {
            background: #0d1117 !important;
            color: #f0f6fc !important;
        }

        body.dark-mode::before {
            display: none;
        }

        .dark-mode .container {
            background: #161b22 !important;
            border: 1px solid #30363d !important;
            color: #f0f6fc !important;
        }

        .dark-mode .header {
            background: linear-gradient(135deg, #21262d 0%, #30363d 100%) !important;
            color: #f0f6fc !important;
        }

        .dark-mode .panel,
        .dark-mode .statistics,
        .dark-mode .upload-area,
        .dark-mode .progress-container {
            background: #21262d !important;
            border: 1px solid #30363d !important;
            color: #f0f6fc !important;
        }

        .dark-mode .stat-item {
            background: #30363d !important;
            color: #f0f6fc !important;
        }

        .dark-mode .btn {
            background: #238636 !important;
            border: 1px solid #30363d !important;
            color: #f0f6fc !important;
        }

        .dark-mode .btn:hover {
            background: #2ea043 !important;
        }

        .dark-mode .feedback-item {
            background: #21262d !important;
            border-left-color: #667eea !important;
            color: #f0f6fc !important;
        }

        .dark-mode .chat-container {
            background: #0d1117 !important;
            border: 1px solid #30363d !important;
            color: #f0f6fc !important;
        }

        .dark-mode .chat-message.assistant {
            background: #21262d !important;
            border: 1px solid #30363d !important;
            color: #f0f6fc !important;
        }

        .dark-mode .chat-message.user {
            background: #1f6feb !important;
            color: #ffffff !important;
        }

        .dark-mode .form-input,
        .dark-mode .form-select,
        .dark-mode .form-textarea,
        .dark-mode .section-select,
        .dark-mode .chat-input {
            background: #21262d !important;
            border: 1px solid #30363d !important;
            color: #f0f6fc !important;
        }

        .dark-mode .form-input:focus,
        .dark-mode .form-select:focus,
        .dark-mode .form-textarea:focus,
        .dark-mode .section-select:focus,
        .dark-mode .chat-input:focus {
            border-color: #1f6feb !important;
            outline: none !important;
        }

        .dark-mode .modal {
            background: rgba(0, 0, 0, 0.8) !important;
        }

        .dark-mode .modal-content {
            background: #0d1117 !important;
            color: #f0f6fc !important;
            border: 1px solid #30363d !important;
        }

        .dark-mode .modal-header {
            border-bottom: 2px solid #30363d !important;
        }

        .dark-mode .modal-close {
            color: #f0f6fc !important;
        }

        .dark-mode .modal-close:hover {
            color: #1f6feb !important;
        }

        .dark-mode .tab {
            background: #21262d !important;
            color: #f0f6fc !important;
            border: 1px solid #30363d !important;
        }

        .dark-mode .tab.active {
            background: #0d1117 !important;
            color: #1f6feb !important;
            border-bottom: 2px solid #1f6feb !important;
        }

        .dark-mode .tabs {
            background: #30363d !important;
        }

        .dark-mode .custom-feedback-form {
            background: #21262d !important;
            border: 1px solid #30363d !important;
            color: #f0f6fc !important;
        }

        .dark-mode .document-header,
        .dark-mode .feedback-header,
        .dark-mode .custom-feedback-fixed {
            background: #0d1117 !important;
            border-color: #30363d !important;
            color: #f0f6fc !important;
        }

        .dark-mode .document-progress {
            background: #0d1117 !important;
            border: 1px solid #30363d !important;
            color: #f0f6fc !important;
        }

        .dark-mode .form-label {
            color: #f0f6fc !important;
        }

        .dark-mode .suggestion-dropdown {
            background: #21262d !important;
            border: 1px solid #30363d !important;
            color: #f0f6fc !important;
        }

        .dark-mode .suggestion-item:hover {
            background: #30363d !important;
        }

        .dark-mode .dashboard-card {
            background: #21262d !important;
            border: 1px solid #30363d !important;
            color: #f0f6fc !important;
        }

        .dark-mode .notification {
            background: #21262d !important;
            border: 1px solid #30363d !important;
            color: #f0f6fc !important;
        }

        .dark-mode .notification.success {
            background: #238636 !important;
            color: #ffffff !important;
        }

        .dark-mode .notification.error {
            background: #da3633 !important;
            color: #ffffff !important;
        }

        .dark-mode .notification.info {
            background: #1f6feb !important;
            color: #ffffff !important;
        }

        .dark-mode .loading-overlay {
            background: rgba(13, 17, 23, 0.9) !important;
        }

        .dark-mode .loading-content {
            background: rgba(33, 38, 45, 0.9) !important;
            color: #f0f6fc !important;
            border: 1px solid #30363d !important;
        }

        .dark-mode .shortcut-key {
            background: #30363d !important;
            color: #f0f6fc !important;
        }

        .dark-mode table th,
        .dark-mode table td {
            border-bottom: 1px solid #30363d !important;
            color: #f0f6fc !important;
        }

        .dark-mode table th {
            background: #21262d !important;
        }

        .dark-mode .panel-header {
            background: linear-gradient(135deg, #21262d 0%, #30363d 100%) !important;
            color: #f0f6fc !important;
        }

        .dark-mode #analysisProgressPanel {
            background: #0d1117 !important;
            border: 1px solid #30363d !important;
            color: #f0f6fc !important;
        }

        .dark-mode #analysisProgressPanel h3 {
            color: #1f6feb !important;
        }

        .dark-mode #progressBar {
            background: #30363d !important;
        }

        .dark-mode #sectionProgress {
            background: #21262d !important;
            border: 1px solid #30363d !important;
            color: #f0f6fc !important;
        }

        .dark-mode #progressText,
        .dark-mode #progressSubtext {
            color: #f0f6fc !important;
        }

        .dark-mode .upload-area:hover {
            background: #21262d !important;
            border-color: #1f6feb !important;
        }

        .dark-mode .upload-area.dragover {
            background: #0d1117 !important;
            border-color: #238636 !important;
        }

        .dark-mode .risk-indicator {
            color: #ffffff !important;
        }

        .dark-mode .feedback-type {
            color: #ffffff !important;
        }

        .dark-mode .stat-number {
            color: #1f6feb !important;
        }

        .dark-mode .stat-label {
            color: #8b949e !important;
        }

        .dark-mode .tab-content {
            background: #0d1117 !important;
            color: #f0f6fc !important;
        }

        .dark-mode .panel-content {
            background: #0d1117 !important;
            color: #f0f6fc !important;
        }

        .dark-mode #documentContent {
            background: #ffffff !important;
            color: #000000 !important;
            border: 1px solid #30363d !important;
        }

        .dark-mode .controls {
            background: transparent !important;
        }

        .dark-mode .btn-primary {
            background: #1f6feb !important;
            border-color: #1f6feb !important;
        }

        .dark-mode .btn-success {
            background: #238636 !important;
            border-color: #238636 !important;
        }

        .dark-mode .btn-danger {
            background: #da3633 !important;
            border-color: #da3633 !important;
        }

        .dark-mode .btn-warning {
            background: #fb8500 !important;
            border-color: #fb8500 !important;
        }

        .dark-mode .btn-info {
            background: #1f6feb !important;
            border-color: #1f6feb !important;
        }

        .dark-mode .btn-secondary {
            background: #6e7681 !important;
            border-color: #6e7681 !important;
        }

        .dark-mode .btn:disabled {
            background: #30363d !important;
            color: #6e7681 !important;
            border-color: #30363d !important;
        }

        /* Enhanced Mobile and Tablet Responsive Design */
        @media (max-width: 480px) {
            .container {
                padding: 5px;
                margin: 0;
                border-radius: 0;
                width: 100vw;
                max-width: 100vw;
            }
            
            .header h1 {
                font-size: 1.5em;
            }
            
            .header p {
                font-size: 0.9em;
            }
            
            .main-content {
                grid-template-columns: 1fr;
                gap: 10px;
                height: auto;
            }
            
            .panel-content {
                height: 400px;
            }
            
            .document-content-scroll,
            .feedback-content-scroll {
                padding: 10px;
            }
            
            .document-header,
            .feedback-header,
            .custom-feedback-fixed {
                padding: 10px;
            }
            
            .controls {
                flex-direction: column;
                gap: 10px;
                width: 100%;
            }
            
            .btn {
                width: 100%;
                margin: 5px 0;
                min-height: 44px;
                font-size: 14px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .upload-area {
                padding: 15px;
                margin: 5px;
            }
            
            .modal-content {
                width: 95vw;
                margin: 10px;
                max-height: 90vh;
                padding: 15px;
            }
            
            .custom-feedback-form {
                padding: 10px;
            }
            
            .custom-feedback-form h4 {
                font-size: 1em;
            }
        }
        
        @media (min-width: 481px) and (max-width: 768px) {
            .container {
                padding: 10px;
                margin: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .main-content {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .panel-content {
                height: 500px;
            }
            
            .controls {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .document-content-scroll,
            .feedback-content-scroll {
                padding: 15px;
            }
        }
        
        @media (min-width: 769px) and (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(5, 1fr);
            }
            
            .panel-content {
                height: calc(100vh - 400px);
                min-height: 500px;
            }
        }
        
        @media (min-width: 1025px) {
            .container {
                max-width: 95vw;
                margin: 20px auto;
                padding: 20px;
            }
            
            .main-content {
                gap: 20px;
            }
            
            .panel-content {
                height: calc(100vh - 400px);
                min-height: 600px;
            }
        }

        /* Loading animation with funny GIFs */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }

        .loading-content {
            text-align: center;
            color: white;
            background: rgba(255, 255, 255, 0.1);
            padding: 40px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            max-width: 500px;
            width: 90%;
        }

        .loading-gif {
            width: 200px;
            height: 200px;
            border-radius: 15px;
            margin: 0 auto 20px auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: block;
        }

        .document-progress {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            z-index: 10000;
            max-width: 600px;
            width: 90%;
            text-align: center;
            display: none;
        }

        .progress-gif {
            width: 150px;
            height: 150px;
            margin: 0 auto 20px auto;
            border-radius: 10px;
            display: block;
        }

        .loading-text {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 10px;
            animation: pulse 2s infinite;
        }

        .loading-subtext {
            font-size: 1em;
            opacity: 0.8;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes progress {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Touch-friendly mobile styles */
        @media (max-width: 768px) {
            .btn {
                min-height: 44px;
                font-size: 16px;
            }
            
            .form-input, .form-select, .form-textarea {
                min-height: 44px;
                font-size: 16px;
            }
            
            .chat-input {
                min-height: 44px;
                font-size: 16px;
            }
            
            .feedback-actions .btn {
                min-width: 80px;
                margin: 5px;
            }
        }

        /* Keyboard shortcuts indicator */
        .shortcut-key {
            background: #ecf0f1;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.8em;
        }

        .dark-mode .shortcut-key {
            background: #444;
            color: #e0e0e0;
        }
        
        /* Auto-suggestion dropdown */
        .suggestion-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        
        .suggestion-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        
        .suggestion-item:hover {
            background: #f0f0f0;
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        /* Dashboard styles */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .dashboard-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .chart-container {
            width: 100%;
            height: 300px;
            margin: 20px 0;
        }
        
        /* Revert button styles */
        .revert-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            margin-left: 10px;
        }
        
        .revert-btn:hover {
            background: #c0392b;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üåü AI-Prism Document Analysis and Review Tool</h1>
            <p>AI-Powered Analysis with Hawkeye Investigation Framework</p>
            <p style="font-size: 0.9em; opacity: 0.8; margin-top: 10px;">Professional Document Review and Quality Assurance</p>
        </div>

        <!-- Dark Mode Toggle in Corner -->
        <div style="position: fixed; top: 20px; right: 20px; z-index: 1000;">
            <button class="btn btn-secondary" onclick="toggleDarkMode()" id="darkModeToggle">üåô Dark Mode</button>
        </div>

        <!-- Controls -->
        <div class="controls">
            <button class="btn btn-info" onclick="showShortcuts()">‚å®Ô∏è Shortcuts</button>
            <button class="btn btn-info" onclick="showTutorial()">üîç Tutorial</button>
            <button class="btn btn-info" onclick="showFAQ()">‚ùì FAQs</button>
            <button class="btn btn-info" onclick="showPatterns()">üìä Patterns</button>
            <button class="btn btn-info" onclick="showLogs()">üìã Logs</button>
            <button class="btn btn-info" onclick="showLearning()">üß† Learning</button>
            <button class="btn btn-warning" onclick="resetSession()">üîÑ Reset</button>
        </div>

        <!-- Upload Area - Always Visible -->
        <div class="upload-area" id="uploadArea">
            <h3>üìÑ Upload Documents</h3>
            
            <!-- Main Document Upload -->
            <div style="margin-bottom: 20px; padding: 15px; border: 2px solid #667eea; border-radius: 10px; background: #f8f9ff;">
                <h4>1. Document for Analysis (Required)</h4>
                <p>Upload the Word document (.docx) you want to analyze</p>
                <input type="file" id="fileInput" class="file-input" accept=".docx">
                <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                    Choose Analysis Document
                </button>
                <span id="analysisFileName" style="margin-left: 10px; color: #2ecc71;"></span>
            </div>
            
            <!-- Guidelines Document Upload -->
            <div style="margin-bottom: 20px; padding: 15px; border: 2px dashed #95a5a6; border-radius: 10px; background: #f8f9fa;">
                <h4>2. Guidelines Document (Optional)</h4>
                <p>Upload custom guidelines or framework document for enhanced analysis</p>
                <input type="file" id="guidelinesInput" class="file-input" accept=".docx">
                <button class="btn btn-info" onclick="document.getElementById('guidelinesInput').click()">
                    Choose Guidelines Document
                </button>
                <span id="guidelinesFileName" style="margin-left: 10px; color: #3498db;"></span>
            </div>
            
            <div style="text-align: center; margin-top: 15px;">
                <button class="btn btn-success" id="startAnalysisBtn" onclick="startAnalysis()" disabled>
                    üöÄ Start Analysis
                </button>
            </div>
        </div>

        <!-- Progress -->
        <div class="progress-container" id="progressContainer" style="display: none;">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <p id="progressText">Processing document...</p>
        </div>

        <!-- Statistics -->
        <div class="statistics" id="statisticsPanel" style="display: none;">
            <div class="stats-grid" id="statsGrid">
                <!-- Statistics will be populated here -->
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content" id="mainContent" style="display: none;">
            <!-- Document Panel -->
            <div class="panel">
                <div class="panel-header">
                    üìÑ Original Document
                </div>
                <div class="panel-content">
                    <div class="document-header">
                        <div class="section-nav">
                            <select class="section-select" id="sectionSelect">
                                <option value="">Select a section...</option>
                            </select>
                            <button class="btn btn-secondary" onclick="previousSection()">‚Üê Previous</button>
                            <button class="btn btn-secondary" onclick="nextSection()">Next ‚Üí</button>
                            <div class="risk-indicator" id="riskIndicator"></div>
                        </div>
                        <div class="zoom-controls" style="display: flex; gap: 10px; align-items: center; margin-top: 10px;">
                            <button class="btn btn-info" onclick="zoomOut()" style="padding: 5px 10px; font-size: 12px;">üîç‚àí Zoom Out</button>
                            <span id="zoomLevel" style="font-size: 12px; color: #666;">100%</span>
                            <button class="btn btn-info" onclick="zoomIn()" style="padding: 5px 10px; font-size: 12px;">üîç+ Zoom In</button>
                            <button class="btn btn-secondary" onclick="resetZoom()" style="padding: 5px 10px; font-size: 12px;">üîÑ Reset</button>
                        </div>
                    </div>
                    <div class="document-content-scroll">
                        <div id="documentContent" style="font-family: 'Times New Roman', serif; line-height: 1.6; background: white; padding: 20px; border: 1px solid #ddd; border-radius: 5px; white-space: pre-wrap; font-size: 12pt;">
                            <p>Upload a document to begin analysis...</p>
                        </div>
                        <div id="currentSectionName" style="display: none;"></div>
                    </div>
                </div>
            </div>

            <!-- Analysis Panel -->
            <div class="panel">
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('feedback')">üìù Feedback</div>
                    <div class="tab" onclick="switchTab('chat')">AI-Prism Chat</div>
                </div>
                
                <!-- Feedback Tab -->
                <div class="tab-content active" id="feedbackTab">
                    <div class="feedback-content-scroll" style="display: flex; flex-direction: column;">
                        <!-- User Added Feedback Display - Show First -->
                        <div id="userFeedbackDisplay" style="margin-bottom: 20px; order: 1;">
                            <!-- User feedback will be displayed here -->
                        </div>
                        
                        <div id="feedbackContainer" style="order: 2;">
                            <p>Select a section to view AI-generated feedback...</p>
                        </div>
                    </div>
                </div>
                
                <!-- AI-Prism Chat Tab -->
                <div class="tab-content" id="chatTab">
                    <div class="feedback-content-scroll">
                        <div class="chat-container" id="chatContainer" style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border: 2px solid #4f46e5; border-radius: 15px; padding: 10px; min-height: 400px; overflow-y: auto;">
                            <div class="chat-message assistant" style="background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); color: white; border-radius: 12px; padding: 20px; margin: 10px; box-shadow: 0 5px 15px rgba(79, 70, 229, 0.3);">
                                <strong>ü™∑ AI-Prism Your Intelligent Assistant:</strong><br><br>
                                ‡§®‡§Æ‡§∏‡•ç‡§§‡•á! üôè I'm AI-Prism, your dedicated AI companion for document excellence. Like a skilled mentor, I'm here to guide you through:<br><br>
                                ‚ú® <strong>Deep insights</strong> into your document's strengths and opportunities<br>
                                üéØ <strong>Hawkeye framework wisdom</strong> and strategic guidance<br>
                                üå± <strong>Creative suggestions</strong> to elevate your content<br>
                                üí´ <strong>Risk assessment</strong> with clarity and precision<br>
                                üå∏ <strong>Best practices</strong> that bloom into exceptional results<br><br>
                                I'm excited to embark on this journey of excellence with you! What aspect of your document shall we explore together? üåü<br><br>
                                <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 8px; margin-top: 15px; font-size: 0.9em;">
                                    üí° <strong>Try asking me:</strong><br>
                                    ‚Ä¢ "What does this feedback mean?"<br>
                                    ‚Ä¢ "How can I improve this section?"<br>
                                    ‚Ä¢ "Explain the Hawkeye framework"<br>
                                    ‚Ä¢ "What are the risk levels?"<br>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="custom-feedback-fixed">
                        <div class="chat-input-container" style="display: flex; gap: 15px; align-items: center; background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(248,250,252,0.95)); border-top: 3px solid #4f46e5; padding: 20px; border-radius: 0 0 15px 15px;">
                            <div style="flex: 1; position: relative;">
                                <input type="text" class="chat-input" id="chatInput" placeholder="Ask AI-Prism about feedback, guidelines, or document analysis..." onkeypress="handleChatKeyPress(event)" style="width: 100%; padding: 15px 20px; border: 3px solid #4f46e5; border-radius: 25px; font-size: 14px; background: linear-gradient(135deg, #ffffff, #f8fafc); box-shadow: 0 5px 15px rgba(79, 70, 229, 0.1);">
                                <div style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #6b7280; font-size: 12px; pointer-events: none;">
                                    Press Enter ‚èé
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="sendChatMessage()" style="padding: 15px 25px; border-radius: 25px; font-weight: 600; box-shadow: 0 5px 15px rgba(79, 70, 229, 0.3);">
                                <span>üöÄ</span> Send
                            </button>
                        </div>
                        <div style="text-align: center; margin-top: 10px; font-size: 0.8em; color: #6b7280; padding: 0 20px 10px 20px;">
                            AI-Prism is powered by advanced AI and ready to help with your document analysis
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Separate Custom Feedback Panel -->
        <div class="custom-feedback-panel" style="background: linear-gradient(135deg, rgba(255,255,255,0.98), rgba(248,250,252,0.98)); backdrop-filter: blur(15px); border-radius: 25px; padding: 35px; margin: 25px; box-shadow: 0 15px 50px rgba(0,0,0,0.15); border: 3px solid rgba(79, 70, 229, 0.2);">
            <div class="custom-feedback-section">
                <h3 style="background: linear-gradient(45deg, #4f46e5, #10b981); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin: 0 0 25px 0; display: flex; align-items: center; gap: 12px; font-size: 1.5em; font-weight: 800;">
                    Add Your Custom Feedback
                </h3>
                <div class="custom-feedback-form" style="background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(248,250,252,0.9)); border: 2px solid #4f46e5; box-shadow: 0 8px 25px rgba(79, 70, 229, 0.15); margin: 0; border-radius: 15px; padding: 25px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label" style="font-weight: 700; color: #4f46e5; font-size: 1em; margin-bottom: 8px;">üè∑Ô∏è Type:</label>
                            <select class="form-select" id="customType" style="border: 3px solid #4f46e5; border-radius: 12px; padding: 12px; background: linear-gradient(135deg, #ffffff, #f8fafc); font-weight: 600;">
                                <option value="suggestion">Suggestion</option>
                                <option value="important">Important</option>
                                <option value="critical">Critical</option>
                                <option value="positive">Positive</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label" style="font-weight: 700; color: #10b981; font-size: 1em; margin-bottom: 8px;">üìÅ Category:</label>
                            <select class="form-select" id="customCategory" style="border: 3px solid #10b981; border-radius: 12px; padding: 12px; background: linear-gradient(135deg, #ffffff, #f0fdf4); font-weight: 600;">
                                <option value="Initial Assessment">Initial Assessment</option>
                                <option value="Investigation Process">Investigation Process</option>
                                <option value="Root Cause Analysis">Root Cause Analysis</option>
                                <option value="Documentation and Reporting">Documentation and Reporting</option>
                                <option value="Seller Classification">Seller Classification</option>
                                <option value="Enforcement Decision-Making">Enforcement Decision-Making</option>
                                <option value="Quality Control">Quality Control</option>
                                <option value="Communication Standards">Communication Standards</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label class="form-label" style="font-weight: 700; color: #ec4899; font-size: 1em; margin-bottom: 8px;">üìù Your Feedback:</label>
                        <div style="position: relative;">
                            <textarea class="form-textarea" id="customDescription" placeholder="Share your insights, suggestions, or observations about this section..." style="border: 3px solid #ec4899; border-radius: 15px; min-height: 100px; padding: 15px; background: linear-gradient(135deg, #ffffff, #fdf2f8); font-size: 14px; line-height: 1.5;" oninput="showAutoSuggestions(this.value)"></textarea>
                            <div class="suggestion-dropdown" id="suggestionDropdown">
                                <!-- Auto-suggestions will appear here -->
                            </div>
                        </div>
                    </div>
                    <div style="text-align: center;">
                        <button class="btn btn-success" onclick="addCustomFeedback()" style="padding: 15px 35px; font-size: 16px; border-radius: 25px; box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4); font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">
                            üåü Add My Feedback
                        </button>
                    </div>
                            
                    <!-- All Custom Feedback History -->
                    <div id="allCustomFeedback" style="margin-top: 25px; max-height: 300px; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h5 style="background: linear-gradient(45deg, #4f46e5, #ec4899); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin: 0; font-size: 1.2em; font-weight: 700;">üìÑ All My Custom Feedback</h5>
                            <div>
                                <button onclick="refreshUserFeedbackList()" style="background: linear-gradient(135deg, #06b6d4, #0891b2); border: none; color: white; cursor: pointer; font-size: 12px; margin-right: 10px; padding: 8px 12px; border-radius: 8px; font-weight: 600;" title="Refresh list">üîÑ</button>
                                <button onclick="showUserFeedbackManager()" style="background: linear-gradient(135deg, #f59e0b, #d97706); border: none; color: white; cursor: pointer; font-size: 12px; padding: 8px 12px; border-radius: 8px; font-weight: 600;" title="Manage all feedback">‚öôÔ∏è</button>
                            </div>
                        </div>
                        <div id="customFeedbackList">
                            <!-- All user feedback will be listed here -->
                        </div>
                        <div style="text-align: center; margin-top: 15px; padding-top: 15px; border-top: 2px solid rgba(79, 70, 229, 0.2);">
                            <button class="btn btn-info" onclick="showUserFeedbackManager()" style="font-size: 14px; padding: 10px 20px; border-radius: 15px; font-weight: 600;">
                                üìù View All My Feedback
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
                </div>

        <!-- Document Progress Panel -->
        <div class="document-progress" id="documentProgress" style="display: none;">
            <div class="loading-content">
                <img id="progressGif" class="progress-gif" src="" alt="Loading..." style="width: 200px; height: 200px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                <div id="progressTitle" class="loading-text" style="font-size: 1.5em; font-weight: bold; margin-bottom: 10px; color: #4f46e5;">ü§ñ AI-Prism is analyzing...</div>
                <div id="progressDesc" class="loading-subtext" style="font-size: 1em; opacity: 0.8; color: #6b7280;">Please wait while magic happens!</div>
                <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px; backdrop-filter: blur(5px);">
                    <div style="font-size: 0.9em; color: #4f46e5; margin-bottom: 5px;">üí° Fun Fact: AI-Prism uses advanced AI to understand context and meaning!</div>
                    <div style="font-size: 0.8em; color: #6b7280;">Rotating through funny memes to keep you entertained üòÑ</div>
                </div>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="controls" id="actionButtons" style="display: none;">
            <button class="btn btn-warning" onclick="revertAllFeedback()" id="revertAllBtn">
                üîÑ Revert All Feedback
            </button>
            <button class="btn btn-info" onclick="updateFeedback()" id="updateFeedbackBtn">
                ‚úèÔ∏è Update Feedback
            </button>
            <button class="btn btn-primary" onclick="showDashboard()" id="dashboardBtn">
                üìä Analytics Dashboard
            </button>
            <button class="btn btn-danger" onclick="deleteDocument()" id="deleteDocBtn">
                üóëÔ∏è Delete Document Only
            </button>
            <button class="btn btn-secondary" onclick="provideFeedbackOnTool()" id="toolFeedbackBtn">
                üí¨ Improve This Tool
            </button>
            <button class="btn btn-success" id="completeReviewBtn" onclick="completeReview()" disabled>
                ‚úÖ Complete Review
            </button>
            <button class="btn btn-info" onclick="exportChatHistory()" id="exportChatBtn">
                üìé Export AI-Prism Conversation
            </button>
            <button class="btn btn-secondary" onclick="downloadGuidelines()" id="downloadGuidelinesBtn">
                üìÑ Download Guidelines
            </button>
            <button class="btn btn-info" onclick="showUserFeedbackManager()" id="userFeedbackManagerBtn">
                üìù Manage My Feedback
            </button>
            <button class="btn btn-warning" onclick="exportAllUserFeedback()" id="exportUserFeedbackBtn">
                üìÑ Export My Feedback
            </button>
            <button class="btn btn-info" onclick="downloadStatistics()" id="downloadStatsBtn">
                üìä Download Statistics
            </button>
            <button class="btn btn-info" onclick="downloadDocument()" id="downloadBtn" disabled>
                üì• Download Document
            </button>
        </div>
    </div>

    <!-- Modals -->
    <!-- Shortcuts Modal -->
    <div class="modal" id="shortcutsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚å®Ô∏è Keyboard Shortcuts</h3>
                <button class="modal-close" onclick="closeModal('shortcutsModal')">&times;</button>
            </div>
            <div style="max-height: 400px; overflow-y: auto;">
                <table style="width: 100%; border-collapse: collapse;">
                    <tr><th style="text-align: left; padding: 8px; border-bottom: 1px solid #eee;">Key</th><th style="text-align: left; padding: 8px; border-bottom: 1px solid #eee;">Action</th></tr>
                    <tr><td style="padding: 8px;"><span class="shortcut-key">N</span></td><td style="padding: 8px;">Next section</td></tr>
                    <tr><td style="padding: 8px;"><span class="shortcut-key">P</span></td><td style="padding: 8px;">Previous section</td></tr>
                    <tr><td style="padding: 8px;"><span class="shortcut-key">A</span></td><td style="padding: 8px;">Accept selected feedback</td></tr>
                    <tr><td style="padding: 8px;"><span class="shortcut-key">R</span></td><td style="padding: 8px;">Reject selected feedback</td></tr>
                    <tr><td style="padding: 8px;"><span class="shortcut-key">F</span></td><td style="padding: 8px;">Focus custom feedback</td></tr>
                    <tr><td style="padding: 8px;"><span class="shortcut-key">C</span></td><td style="padding: 8px;">Focus chat input</td></tr>
                    <tr><td style="padding: 8px;"><span class="shortcut-key">1-2</span></td><td style="padding: 8px;">Switch tabs</td></tr>
                    <tr><td style="padding: 8px;"><span class="shortcut-key">D</span></td><td style="padding: 8px;">Toggle dark mode</td></tr>
                    <tr><td style="padding: 8px;"><span class="shortcut-key">?</span></td><td style="padding: 8px;">Show this help</td></tr>
                </table>
            </div>
        </div>
    </div>

    <!-- FAQ Modal -->
    <div class="modal" id="faqModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚ùì Frequently Asked Questions</h3>
                <button class="modal-close" onclick="closeModal('faqModal')">&times;</button>
            </div>
            <div style="max-height: 500px; overflow-y: auto;">
                <h4>What is the Hawkeye framework?</h4>
                <p>The Hawkeye framework is a 20-point comprehensive investigation checklist used to ensure thorough document review covering impact assessment, root cause analysis, and preventative actions.</p>
                
                <h4>How does the AI generate feedback?</h4>
                <p>The AI analyzes each section against Hawkeye criteria, identifying improvements, missing information, and compliance issues using advanced language models.</p>
                
                <h4>What happens when I accept feedback?</h4>
                <p>Accepted feedback is added as comments to the final document and helps train the AI for future reviews.</p>
                
                <h4>Can I add my own feedback?</h4>
                <p>Yes! Use the "Add Custom Feedback" form to contribute your insights, which will be included in the final document.</p>
                
                <h4>How do I use keyboard shortcuts?</h4>
                <p>Press the '?' key to see all available shortcuts. You can navigate sections with N/P, accept/reject feedback with A/R, and toggle dark mode with D.</p>
                
                <h4>What file formats are supported?</h4>
                <p>Currently, only Microsoft Word (.docx) files are supported for analysis. PDF and other formats will be added in future updates.</p>
                
                <h4>How does the AI learning system work?</h4>
                <p>AI-Prism learns from your feedback patterns - when you accept, reject, or add custom feedback, it adapts to provide more relevant suggestions in future analyses.</p>
            </div>
        </div>
    </div>

    <!-- Generic Modal for dynamic content -->
    <div class="modal" id="genericModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="genericModalTitle">Information</h3>
                <button class="modal-close" onclick="closeModal('genericModal')">&times;</button>
            </div>
            <div id="genericModalContent">
                <!-- Dynamic content will be loaded here -->
            </div>
        </div>
    </div>

    <script src="/static/js/app.js"></script>
    <script>
        // Global variables
        let currentSession = null;
        let sections = [];
        let currentSectionIndex = 0;
        let selectedFeedbackId = null;
        let feedbackStates = {};
        let analysisFile = null;
        let guidelinesFile = null;
        let chatHistory = [];
        let userFeedbackHistory = [];
        let finalDocumentData = null;
        let isDarkMode = false;
        let documentZoom = 100;
        let dashboardData = {
            totalFeedback: 0,
            acceptedFeedback: 0,
            rejectedFeedback: 0,
            userFeedback: 0
        };
        
        // Loading media array
        const loadingMediaWithContent = [
            {
                gif: 'https://media.giphy.com/media/26tn33aiTi1jkl6H6/giphy.gif',
                joke: "What's Iron Man's favorite type of music? Heavy metal! üéµ",
                math: "Physics: If light travels at 300,000 km/s, how far in 1 minute? Answer: 18 million km! ‚ö°"
            },
            {
                gif: 'https://media.giphy.com/media/3o7btPCcdNniyf0ArS/giphy.gif',
                joke: "Why is Sherlock Holmes so good at solving crimes? He always finds the clues elementary! üîç",
                math: "Deduction: If A > B and B > C, then A > C. This is called? Answer: Transitive property! üìä"
            },
            
            // Cartoons & Animation
            {
                gif: 'https://media.giphy.com/media/l3q2K5jinAlChoCLS/giphy.gif',
                joke: "Why is SpongeBob so good at his job? He's always ready! üßΩ",
                math: "Underwater Math: If SpongeBob makes 100 Krabby Patties in 2 hours, what's his rate per hour? Answer: 50 patties/hour! üçî"
            },
            {
                gif: 'https://media.giphy.com/media/3o6Zt4HU9uwXmXSAuI/giphy.gif',
                joke: "What do you call a Minion who works in IT? A tech-nion! üë®‚Äçüíª",
                math: "Minion Math: If there are 3 Minions and each eats 4 bananas, how many bananas total? Answer: 12 bananas! üçå"
            },
            
            // Mathematical & Analytical
            {
                gif: 'https://media.giphy.com/media/26BRrSvJUa0crqw4E/giphy.gif',
                joke: "Why was the equal sign so humble? Because it knew it wasn't less than or greater than anyone! =",
                math: "Algebra Challenge: Solve for x: 2x + 5 = 15. Answer: x = 5! ‚ú®"
            },
            {
                gif: 'https://media.giphy.com/media/3o7btNa0RUYa5E7iiQ/giphy.gif',
                joke: "What did the calculator say to the math student? You can count on me! üßÆ",
                math: "Percentage Puzzle: What's 25% of 80? Answer: 20! (Tip: 25% = 1/4) üìà"
            },
            
            // Office & Work Humor
            {
                gif: 'https://media.giphy.com/media/l0MYGb8Q5QNhNBuDu/giphy.gif',
                joke: "Why don't programmers like nature? It has too many bugs! üêõ",
                math: "Coding Math: In binary, what comes after 1011? Answer: 1100! üíæ"
            },
            {
                gif: 'https://media.giphy.com/media/26u4cqiYI30juCOGY/giphy.gif',
                joke: "What's a computer's favorite snack? Microchips! üçü",
                math: "Data Size: How many bytes in 1 kilobyte? Answer: 1,024 bytes! üíΩ"
            },
            
            // Smart & Nerdy
            {
                gif: 'https://media.giphy.com/media/26BRBKqUiq586bRVm/giphy.gif',
                joke: "Why do mathematicians love parks? Because of all the natural logs! üå≥",
                math: "Logarithm: What's log‚ÇÅ‚ÇÄ(1000)? Answer: 3! (Because 10¬≥ = 1000) üìê"
            },
            {
                gif: 'https://media.giphy.com/media/3o7TKF1fSIs1R19B8k/giphy.gif',
                joke: "What do you call a professor who doesn't fart in public? A private tutor! üéì",
                math: "Statistics: In a normal distribution, what percentage falls within 1 standard deviation? Answer: ~68%! üìä"
            },
            
            // Bonus Fun Content
            {
                gif: 'https://media.giphy.com/media/l0HlBO7eyXzSZkJri/giphy.gif',
                joke: "Why did the scarecrow win an award? He was outstanding in his field! üåæ",
                math: "Geometry: Sum of angles in a triangle? Answer: Always 180¬∞! üìê"
            },
            {
                gif: 'https://media.giphy.com/media/3oriO0OEd9QIDdllqo/giphy.gif',
                joke: "What do you call a fake noodle? An impasta! üçù",
                math: "Time Math: How many seconds in a day? Answer: 86,400 seconds! ‚è∞"
            },
            {
                gif: 'https://media.giphy.com/media/3oEjHCWdU7F4hkcudy/giphy.gif',
                joke: "Why don't scientists trust stairs? Because they're always up to something! ü™ú",
                math: "Fibonacci: What's the next number after 1,1,2,3,5,8? Answer: 13! üî¢"
            }
        ];
        
        let currentMediaIndex = 0;
        let mediaRotationInterval = null;
        let isMediaRotating = false;
        let usedMediaIndices = [];
        let currentContentType = 'gif'; // 'gif', 'joke', 'math'
        
        let showGraphics = true;
        let currentAnalysisStep = 0;
        let totalSections = 0;
        let currentAIModel = 'ai-prism-model';
        window.availableModels = window.availableModels || {
            'ai-prism-model': 'AI-Prism Model (Primary)',
            'ai-prism-backup': 'AI-Prism Backup Model',
            'ai-prism-fast': 'AI-Prism Fast Model',
            'ai-prism-precise': 'AI-Prism Precise Model',
            'ai-prism-comprehensive': 'AI-Prism Comprehensive Model'
        };
        let modelFallbackOrder = ['ai-prism-model', 'ai-prism-backup', 'ai-prism-fast', 'ai-prism-precise', 'ai-prism-comprehensive'];
        let currentModelIndex = 0;
        
        // Notification function
        function showNotification(message, type) {
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(n => n.remove());
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 1001;
                transform: translateX(400px);
                transition: transform 0.3s ease;
                max-width: 300px;
                word-wrap: break-word;
            `;
            
            if (type === 'success') notification.style.background = '#2ecc71';
            else if (type === 'error') notification.style.background = '#e74c3c';
            else if (type === 'info') notification.style.background = '#3498db';
            else notification.style.background = '#95a5a6';
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            setTimeout(() => {
                notification.style.transform = 'translateX(400px)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('AI-Prism initializing...');
            try {
                setupEventListeners();
                setupKeyboardShortcuts();
                setupDragAndDrop();
                loadDarkModePreference();
                showNotification('AI-Prism loaded successfully! Upload a document to begin.', 'success');
            } catch (error) {
                console.error('Initialization error:', error);
                showNotification('Initialization error: ' + error.message, 'error');
            }
        });
        
        function setupEventListeners() {
            // File input changes
            const fileInput = document.getElementById('fileInput');
            const guidelinesInput = document.getElementById('guidelinesInput');
            const sectionSelect = document.getElementById('sectionSelect');
            
            if (fileInput) fileInput.addEventListener('change', handleAnalysisFileUpload);
            if (guidelinesInput) guidelinesInput.addEventListener('change', handleGuidelinesFileUpload);
            
            if (sectionSelect) {
                sectionSelect.addEventListener('change', function() {
                    const selectedIndex = this.selectedIndex - 1;
                    if (selectedIndex >= 0) {
                        loadSection(selectedIndex);
                    }
                });
            }
        }
        
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    return;
                }
                
                switch(e.key.toLowerCase()) {
                    case 'n':
                        e.preventDefault();
                        nextSection();
                        break;
                    case 'p':
                        e.preventDefault();
                        previousSection();
                        break;
                    case 'd':
                        e.preventDefault();
                        toggleDarkMode();
                        break;
                    case '?':
                        e.preventDefault();
                        showShortcuts();
                        break;
                }
            });
        }
        
        function setupDragAndDrop() {
            const uploadArea = document.getElementById('uploadArea');
            if (!uploadArea) return;
            
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].name.toLowerCase().endsWith('.docx')) {
                    analysisFile = files[0];
                    document.getElementById('analysisFileName').textContent = files[0].name;
                    document.getElementById('startAnalysisBtn').disabled = false;
                    showNotification('Analysis document ready!', 'success');
                } else {
                    showNotification('Please drop a .docx file', 'error');
                }
            });
        }
        
        function loadDarkModePreference() {
            const savedDarkMode = localStorage.getItem('darkMode');
            if (savedDarkMode === 'true') {
                isDarkMode = true;
                document.body.classList.add('dark-mode');
                const button = document.getElementById('darkModeToggle');
                if (button) {
                    button.textContent = '‚òÄÔ∏è Light Mode';
                    button.className = 'btn btn-warning';
                }
            }
        }
        
        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode', isDarkMode);
            
            const button = document.getElementById('darkModeToggle');
            if (button) {
                button.textContent = isDarkMode ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode';
                button.className = isDarkMode ? 'btn btn-warning' : 'btn btn-secondary';
            }
            
            localStorage.setItem('darkMode', isDarkMode.toString());
        }
        
        function showShortcuts() {
            const modal = document.getElementById('shortcutsModal');
            if (modal) modal.style.display = 'block';
        }
        
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.style.display = 'none';
        }
        
        function handleAnalysisFileUpload(event) {
            const file = event.target.files[0];
            if (file && file.name.toLowerCase().endsWith('.docx')) {
                analysisFile = file;
                document.getElementById('analysisFileName').textContent = file.name;
                document.getElementById('startAnalysisBtn').disabled = false;
                showNotification('Analysis document ready!', 'success');
            } else {
                showNotification('Please select a .docx file', 'error');
            }
        }
        
        function handleGuidelinesFileUpload(event) {
            const file = event.target.files[0];
            if (file && file.name.toLowerCase().endsWith('.docx')) {
                guidelinesFile = file;
                document.getElementById('guidelinesFileName').textContent = file.name;
                showNotification('Guidelines document ready!', 'info');
            } else {
                showNotification('Please select a .docx file for guidelines', 'error');
            }
        }
        
        // Placeholder functions for missing functionality
        function nextSection() { showNotification('Next section functionality not implemented', 'info'); }
        function previousSection() { showNotification('Previous section functionality not implemented', 'info'); }
        function loadSection(index) { showNotification('Load section functionality not implemented', 'info'); }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            setupKeyboardShortcuts();
            setupDragAndDrop();
            loadDarkModePreference();
        });
        
        function loadDarkModePreference() {
            const savedDarkMode = localStorage.getItem('darkMode');
            if (savedDarkMode === 'true') {
                isDarkMode = true;
                document.body.classList.add('dark-mode');
                const button = document.getElementById('darkModeToggle');
                if (button) {
                    button.textContent = '‚òÄÔ∏è Light Mode';
                    button.className = 'btn btn-warning';
                }
            }
        }

        function setupEventListeners() {
            // File input changes
            document.getElementById('fileInput').addEventListener('change', handleAnalysisFileUpload);
            document.getElementById('guidelinesInput').addEventListener('change', handleGuidelinesFileUpload);
            
            // Section select change
            document.getElementById('sectionSelect').addEventListener('change', function() {
                const selectedIndex = this.selectedIndex - 1; // -1 because first option is placeholder
                if (selectedIndex >= 0) {
                    loadSection(selectedIndex);
                }
            });
        }

        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Don't trigger shortcuts when typing in inputs
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    return;
                }

                switch(e.key.toLowerCase()) {
                    case 'n':
                        e.preventDefault();
                        nextSection();
                        break;
                    case 'p':
                        e.preventDefault();
                        previousSection();
                        break;
                    case 'a':
                        e.preventDefault();
                        if (selectedFeedbackId) {
                            acceptFeedback(selectedFeedbackId);
                        }
                        break;
                    case 'r':
                        e.preventDefault();
                        if (selectedFeedbackId) {
                            rejectFeedback(selectedFeedbackId);
                        }
                        break;
                    case 'f':
                        e.preventDefault();
                        document.getElementById('customDescription').focus();
                        break;
                    case 'c':
                        e.preventDefault();
                        document.getElementById('chatInput').focus();
                        break;
                    case 'd':
                        e.preventDefault();
                        toggleDarkMode();
                        break;
                    case '1':
                        e.preventDefault();
                        switchTab('feedback');
                        break;
                    case '2':
                        e.preventDefault();
                        switchTab('chat');
                        break;
                    case '?':
                        e.preventDefault();
                        showShortcuts();
                        break;
                }
            });
        }

        function setupDragAndDrop() {
            const uploadArea = document.getElementById('uploadArea');
            
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    // Set as analysis file by default
                    if (files[0].name.toLowerCase().endsWith('.docx')) {
                        analysisFile = files[0];
                        document.getElementById('analysisFileName').textContent = files[0].name;
                        document.getElementById('startAnalysisBtn').disabled = false;
                        showNotification('Analysis document ready. Click "Start Analysis" to begin.', 'info');
                    } else {
                        showNotification('Please drop a .docx file', 'error');
                    }
                }
            });
        }

        function handleAnalysisFileUpload(event) {
            try {
                const file = event.target.files[0];
                if (file) {
                    console.log('File selected:', file.name, 'Size:', file.size, 'Type:', file.type);
                    
                    if (!file.name.toLowerCase().endsWith('.docx')) {
                        showNotification('Please select a .docx file for analysis', 'error');
                        return;
                    }
                    
                    if (file.size > 16 * 1024 * 1024) {
                        showNotification('File size must be less than 16MB', 'error');
                        return;
                    }
                    
                    analysisFile = file;
                    const fileNameElement = document.getElementById('analysisFileName');
                    const startBtn = document.getElementById('startAnalysisBtn');
                    
                    if (fileNameElement) fileNameElement.textContent = file.name;
                    if (startBtn) startBtn.disabled = false;
                    
                    showNotification('Analysis document ready!', 'success');
                } else {
                    console.log('No file selected');
                }
            } catch (error) {
                console.error('File upload error:', error);
                showNotification('File upload error: ' + error.message, 'error');
            }
        }

        function handleGuidelinesFileUpload(event) {
            try {
                const file = event.target.files[0];
                if (file) {
                    console.log('Guidelines file selected:', file.name, 'Size:', file.size);
                    
                    if (!file.name.toLowerCase().endsWith('.docx')) {
                        showNotification('Please select a .docx file for guidelines', 'error');
                        return;
                    }
                    
                    if (file.size > 16 * 1024 * 1024) {
                        showNotification('Guidelines file size must be less than 16MB', 'error');
                        return;
                    }
                    
                    guidelinesFile = file;
                    const fileNameElement = document.getElementById('guidelinesFileName');
                    if (fileNameElement) fileNameElement.textContent = file.name;
                    
                    showNotification('Guidelines document ready!', 'info');
                } else {
                    console.log('No guidelines file selected');
                }
            } catch (error) {
                console.error('Guidelines file upload error:', error);
                showNotification('Guidelines file upload error: ' + error.message, 'error');
            }
        }

        function startAnalysis() {
            try {
                console.log('Starting analysis...');
                console.log('Analysis file:', analysisFile ? analysisFile.name : 'None');
                console.log('Guidelines file:', guidelinesFile ? guidelinesFile.name : 'None');
                
                if (!analysisFile) {
                    showNotification('Please select a document for analysis', 'error');
                    return;
                }
                
                // Disable the button to prevent double-clicks
                const startBtn = document.getElementById('startAnalysisBtn');
                if (startBtn) {
                    startBtn.disabled = true;
                    startBtn.textContent = 'Starting...';
                }
                
                handleFileSelection(analysisFile, guidelinesFile);
            } catch (error) {
                console.error('Start analysis error:', error);
                showNotification('Failed to start analysis: ' + error.message, 'error');
                
                // Re-enable button on error
                const startBtn = document.getElementById('startAnalysisBtn');
                if (startBtn) {
                    startBtn.disabled = false;
                    startBtn.textContent = 'üöÄ Start Analysis';
                }
            }
        }

        function handleFileSelection(analysisFile, guidelinesFile = null) {
            // Show guidelines preference modal if guidelines file is provided
            if (guidelinesFile) {
                showGuidelinesPreferenceModal(analysisFile, guidelinesFile);
                return;
            }
            
            uploadAndAnalyze(analysisFile, guidelinesFile, 'both');
        }
        
        function showGuidelinesPreferenceModal(analysisFile, guidelinesFile) {
            const modalContent = `
                <div style="text-align: center; padding: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 20px;">üìÑ Guidelines Document Detected</h3>
                    <p style="margin-bottom: 30px;">You've uploaded a custom guidelines document. How should AI-Prism use it?</p>
                    
                    <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="useGuidelinesPreference('new_only')" style="padding: 15px 25px;">
                            üÜï Use Only New Guidelines
                        </button>
                        <button class="btn btn-success" onclick="useGuidelinesPreference('both')" style="padding: 15px 25px;">
                            üîÑ Use Both Old & New Guidelines
                        </button>
                        <button class="btn btn-secondary" onclick="useGuidelinesPreference('old_only')" style="padding: 15px 25px;">
                            üìÖ Use Only Default Guidelines
                        </button>
                    </div>
                    
                    <p style="margin-top: 20px; font-size: 0.9em; color: #666;">
                        AI-Prism will analyze your document according to your preference.
                    </p>
                </div>
            `;
            
            showModal('genericModal', 'Guidelines Preference', modalContent);
            
            // Store files for later use
            window.tempAnalysisFile = analysisFile;
            window.tempGuidelinesFile = guidelinesFile;
        }
        
        function useGuidelinesPreference(preference) {
            closeModal('genericModal');
            
            const analysisFile = window.tempAnalysisFile;
            const guidelinesFile = window.tempGuidelinesFile;
            
            uploadAndAnalyze(analysisFile, guidelinesFile, preference);
        }
        
        function uploadAndAnalyze(analysisFile, guidelinesFile, guidelinesPreference) {
            try {
                if (!analysisFile) {
                    showNotification('No analysis file provided', 'error');
                    return;
                }
                
                const formData = new FormData();
                formData.append('document', analysisFile);
                formData.append('guidelines_preference', guidelinesPreference);
                
                if (guidelinesFile && guidelinesPreference !== 'old_only') {
                    formData.append('guidelines', guidelinesFile);
                }

                showProgress('Uploading documents...');

                fetch('/upload', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        currentSession = data.session_id;
                        sections = data.sections;
                        totalSections = sections.length;
                        
                        populateSectionSelect(data.sections);
                        showMainContent();
                        
                        // Start comprehensive analysis of all sections
                        startComprehensiveAnalysis();
                        
                        let message = 'Documents uploaded successfully!';
                        if (data.guidelines_uploaded) {
                            message += ` Using ${guidelinesPreference.replace('_', ' ')} guidelines.`;
                        }
                        showNotification(message, 'success');
                    } else {
                        showNotification(data.error || 'Upload failed', 'error');
                        hideProgress();
                    }
                })
                .catch(error => {
                    console.error('Upload error:', error);
                    showNotification('Upload failed: ' + error.message, 'error');
                    hideProgress();
                });
            } catch (error) {
                console.error('Upload setup error:', error);
                showNotification('Upload setup failed: ' + error.message, 'error');
            }
        }

        function populateSectionSelect(sectionNames) {
            const select = document.getElementById('sectionSelect');
            select.innerHTML = '<option value="">Select a section...</option>';
            
            sectionNames.forEach((section, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = section;
                select.appendChild(option);
            });
        }

        function showMainContent() {
            document.getElementById('mainContent').style.display = 'grid';
            document.getElementById('statisticsPanel').style.display = 'block';
            document.getElementById('actionButtons').style.display = 'flex';
            updateStatistics();
        }

        function startComprehensiveAnalysis() {
            showProgress('Starting comprehensive analysis...');
            
            currentAnalysisStep = 0;
            
            // Analyze all sections sequentially
            analyzeNextSection();
        }
        
        function analyzeNextSection() {
            if (currentAnalysisStep >= totalSections) {
                // Analysis complete
                completeAnalysis();
                return;
            }
            
            const sectionName = sections[currentAnalysisStep];
            const progressPercent = ((currentAnalysisStep + 1) / totalSections) * 100;
            
            // Update progress with fun messages
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const progressTitle = document.getElementById('progressTitle');
            const progressDesc = document.getElementById('progressDesc');
            
            if (progressFill) progressFill.style.width = progressPercent + '%';
            if (progressText) progressText.textContent = `Analyzing: ${sectionName} (${currentAnalysisStep + 1}/${totalSections})`;
            
            // Update fun messages for each section
            if (progressTitle && progressDesc) {
                const sectionMessages = [
                    `üîç AI-Prism is investigating "${sectionName}" like a detective...`,
                    `üìö AI-Prism is studying "${sectionName}" with scholarly precision...`,
                    `üéØ AI-Prism is targeting "${sectionName}" for deep analysis...`,
                    `üß† AI-Prism is brain-storming about "${sectionName}"...`,
                    `üé™ AI-Prism is performing analytical magic on "${sectionName}"...`
                ];
                
                const sectionSubtexts = [
                    `Section ${currentAnalysisStep + 1} of ${totalSections} - ${Math.round(progressPercent)}% complete`,
                    `Applying Hawkeye framework to this section`,
                    `Cross-referencing with quality standards`,
                    `Checking for compliance and best practices`,
                    `Almost there! Quality analysis in progress`
                ];
                
                progressTitle.textContent = sectionMessages[Math.floor(Math.random() * sectionMessages.length)];
                progressDesc.textContent = sectionSubtexts[Math.floor(Math.random() * sectionSubtexts.length)];
            }
            
            // Analyze current section
            fetch('/analyze_section', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    session_id: currentSession,
                    section_name: sectionName
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Store section data
                    window.sectionData = window.sectionData || {};
                    window.sectionData[sectionName] = {
                        content: data.section_content,
                        feedback: data.feedback_items
                    };
                    
                    currentAnalysisStep++;
                    
                    // Continue with next section after a short delay
                    setTimeout(analyzeNextSection, 1000);
                } else {
                    currentAnalysisStep++;
                    setTimeout(analyzeNextSection, 500);
                }
            })
            .catch(error => {
                currentAnalysisStep++;
                setTimeout(analyzeNextSection, 500);
            });
        }
        
        function completeAnalysis() {
            const progressText = document.getElementById('progressText');
            if (progressText) progressText.textContent = 'Analysis Complete!';
            
            setTimeout(() => {
                hideProgress();
                loadSection(0); // Load first section
                updateStatistics();
                const completeBtn = document.getElementById('completeReviewBtn');
                if (completeBtn) completeBtn.disabled = false;
                showNotification('Comprehensive analysis completed! Navigate through sections to review feedback.', 'success');
            }, 2000);
        }
        
        function loadSection(index) {
            if (index < 0 || index >= sections.length) return;
            
            currentSectionIndex = index;
            const sectionName = sections[index];
            
            // Update section select
            const sectionSelect = document.getElementById('sectionSelect');
            if (sectionSelect) sectionSelect.value = index;
            
            // Clear user feedback display
            const userFeedbackDisplay = document.getElementById('userFeedbackDisplay');
            if (userFeedbackDisplay) userFeedbackDisplay.innerHTML = '';
            
            // Load from stored data
            if (window.sectionData && window.sectionData[sectionName]) {
                const data = window.sectionData[sectionName];
                displaySectionContent(data.content, sectionName);
                displayFeedback(data.feedback, sectionName);
                updateRiskIndicator(data.feedback);
                
                // Load any existing user feedback for this section
                loadUserFeedbackForSection(sectionName);
            } else {
                // Fallback to API call if data not stored
                showProgress('Loading section...');
                
                fetch('/analyze_section', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        session_id: currentSession,
                        section_name: sectionName
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displaySectionContent(data.section_content, sectionName);
                        displayFeedback(data.feedback_items, sectionName);
                        updateRiskIndicator(data.feedback_items);
                        loadUserFeedbackForSection(sectionName);
                    }
                    hideProgress();
                })
                .catch(error => {
                    hideProgress();
                    showNotification('Failed to load section: ' + error.message, 'error');
                });
            }
        }
        
        function loadUserFeedbackForSection(sectionName) {
            // Display any existing user feedback for this section
            const sectionUserFeedback = userFeedbackHistory.filter(item => item.section === sectionName);
            sectionUserFeedback.forEach(item => {
                displayUserFeedback(item);
            });
            
            // Update the all custom feedback list
            updateAllCustomFeedbackList();
        }

        function displaySectionContent(content, sectionName) {
            const container = document.getElementById('documentContent');
            
            // Format content to look exactly like a Word document
            const formattedContent = content
                .replace(/\n\n/g, '</p><p style="margin: 12pt 0; text-align: justify;">')
                .replace(/\n/g, '<br>')
                .replace(/^/, '<p style="margin: 12pt 0; text-align: justify;">')
                .replace(/$/, '</p>');
            
            container.innerHTML = `
                <div style="background: white; padding: 1in; margin: 0; box-shadow: 0 0 10px rgba(0,0,0,0.1); min-height: 11in; width: 8.5in; margin: 0 auto; position: relative;">
                    <!-- Word document header -->
                    <div style="text-align: center; margin-bottom: 24pt; border-bottom: 1pt solid #000; padding-bottom: 12pt;">
                        <h1 style="font-family: 'Times New Roman', serif; font-size: 16pt; font-weight: bold; margin: 0; text-transform: uppercase;">${sectionName}</h1>
                    </div>
                    
                    <!-- Document content with Word-like formatting -->
                    <div style="font-family: 'Times New Roman', serif; font-size: 12pt; line-height: 1.5; text-align: justify;">
                        ${formattedContent}
                    </div>
                    
                    <!-- Page number -->
                    <div style="position: absolute; bottom: 0.5in; right: 1in; font-family: 'Times New Roman', serif; font-size: 10pt; color: #666;">
                        Page ${currentSectionIndex + 1}
                    </div>
                </div>
            `;
        }

        function displayFeedback(feedbackItems, sectionName) {
            const container = document.getElementById('feedbackContainer');
            
            if (!feedbackItems || feedbackItems.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; background: #f0fff4; border-radius: 8px;">
                        <p style="color: #2ecc71; font-size: 16px;">
                            ‚úì No issues found in this section based on Hawkeye criteria
                        </p>
                    </div>
                `;
                return;
            }

            let html = '';
            feedbackItems.forEach(item => {
                const riskClass = `risk-${item.risk_level.toLowerCase()}`;
                const typeClass = `type-${item.type}`;
                
                html += `
                    <div class="feedback-item" data-feedback-id="${item.id}" onclick="selectFeedback('${item.id}')">
                        <div class="feedback-header">
                            <div class="feedback-meta">
                                <span class="feedback-type ${typeClass}">${item.type}</span>
                                <span class="risk-indicator ${riskClass}">${item.risk_level} Risk</span>
                                <span style="color: #7f8c8d; font-size: 0.9em;">${item.category}</span>
                            </div>
                        </div>
                        <p><strong>Description:</strong> ${item.description}</p>
                        ${item.suggestion ? `<p><strong>Suggestion:</strong> ${item.suggestion}</p>` : ''}
                        ${item.example ? `<p><strong>Example:</strong> ${item.example}</p>` : ''}
                        ${item.questions && item.questions.length > 0 ? `
                            <div>
                                <strong>Key Questions:</strong>
                                <ul>
                                    ${item.questions.map(q => `<li>${q}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        ${item.hawkeye_refs && item.hawkeye_refs.length > 0 ? `
                            <p><strong>Hawkeye References:</strong> ${item.hawkeye_refs.map(ref => `#${ref}`).join(', ')}</p>
                        ` : ''}
                        <p><small>Confidence: ${Math.round(item.confidence * 100)}%</small></p>
                        <div class="feedback-actions">
                            <button class="btn btn-success" onclick="acceptFeedback('${item.id}', event)">‚úì Accept</button>
                            <button class="btn btn-danger" onclick="rejectFeedback('${item.id}', event)">‚úó Reject</button>
                            <button class="btn btn-warning" onclick="revertFeedback('${item.id}', event)" style="font-size: 12px; padding: 5px 10px;">üîÑ Revert</button>
                            <button class="btn btn-info" onclick="addCustomToAI('${item.id}', event)" style="font-size: 12px; padding: 5px 10px;">‚ú® Add My Feedback</button>
                        </div>
                        <div id="custom-${item.id}" class="ai-custom-feedback" style="display: none; margin-top: 15px; padding: 15px; background: linear-gradient(135deg, #f0f8ff 0%, #e8f4fd 100%); border-radius: 10px; border: 2px solid #3498db; box-shadow: 0 3px 10px rgba(52, 152, 219, 0.2);">
                            <h5 style="color: #3498db; margin-bottom: 15px; font-size: 1.1em;">‚ú® Add Your Custom Feedback to This AI Suggestion</h5>
                            <div style="background: rgba(52, 152, 219, 0.1); padding: 10px; border-radius: 5px; margin-bottom: 15px; font-size: 0.9em;">
                                <strong>AI Suggestion:</strong> ${item.description.substring(0, 100)}...
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <label style="font-weight: 600; color: #555; font-size: 0.9em; margin-bottom: 5px; display: block;">üè∑Ô∏è Your Feedback Type:</label>
                                    <select class="form-select" id="aiCustomType-${item.id}" style="padding: 10px; border: 2px solid #3498db; border-radius: 8px; width: 100%;">
                                        <option value="addition">Addition - Add more info</option>
                                        <option value="clarification">Clarification - Explain better</option>
                                        <option value="disagreement">Disagreement - I disagree</option>
                                        <option value="enhancement">Enhancement - Improve this</option>
                                        <option value="alternative">Alternative - Different approach</option>
                                        <option value="context">Context - Missing context</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="font-weight: 600; color: #555; font-size: 0.9em; margin-bottom: 5px; display: block;">üìÅ Category:</label>
                                    <select class="form-select" id="aiCustomCategory-${item.id}" style="padding: 10px; border: 2px solid #3498db; border-radius: 8px; width: 100%;">
                                        <option value="${item.category}">${item.category}</option>
                                        <option value="Initial Assessment">Initial Assessment</option>
                                        <option value="Investigation Process">Investigation Process</option>
                                        <option value="Root Cause Analysis">Root Cause Analysis</option>
                                        <option value="Documentation and Reporting">Documentation and Reporting</option>
                                        <option value="Seller Classification">Seller Classification</option>
                                        <option value="Enforcement Decision-Making">Enforcement Decision-Making</option>
                                        <option value="Quality Control">Quality Control</option>
                                        <option value="Communication Standards">Communication Standards</option>
                                    </select>
                                </div>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="font-weight: 600; color: #555; font-size: 0.9em; margin-bottom: 5px; display: block;">üìù Your Feedback:</label>
                                <textarea id="aiCustomDesc-${item.id}" placeholder="Share your thoughts about this AI suggestion. What would you add, change, or clarify?" style="width: 100%; height: 100px; padding: 12px; border: 2px solid #3498db; border-radius: 8px; font-family: inherit; resize: vertical;"></textarea>
                            </div>
                            <div style="text-align: center; border-top: 1px solid #ddd; padding-top: 15px;">
                                <button class="btn btn-success" onclick="saveAICustomFeedback('${item.id}')" style="padding: 10px 20px; font-size: 14px; border-radius: 20px; margin-right: 10px;">‚úì Save My Feedback</button>
                                <button class="btn btn-secondary" onclick="cancelAICustom('${item.id}')" style="padding: 10px 20px; font-size: 14px; border-radius: 20px;">‚úó Cancel</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function selectFeedback(feedbackId) {
            // Remove previous selection
            document.querySelectorAll('.feedback-item').forEach(item => {
                item.style.border = '';
            });
            
            // Highlight selected feedback
            const selectedItem = document.querySelector(`[data-feedback-id="${feedbackId}"]`);
            if (selectedItem) {
                selectedItem.style.border = '2px solid #667eea';
                selectedFeedbackId = feedbackId;
            }
        }

        function acceptFeedback(feedbackId, event) {
            if (event) event.stopPropagation();
            
            fetch('/accept_feedback', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    session_id: currentSession,
                    section_name: sections[currentSectionIndex],
                    feedback_id: feedbackId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Feedback accepted!', 'success');
                    updateFeedbackStatus(feedbackId, 'accepted');
                    updateStatistics();
                } else {
                    showNotification(data.error || 'Accept failed', 'error');
                }
            })
            .catch(error => {
                showNotification('Accept failed: ' + error.message, 'error');
            });
        }

        function rejectFeedback(feedbackId, event) {
            if (event) event.stopPropagation();
            
            fetch('/reject_feedback', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    session_id: currentSession,
                    section_name: sections[currentSectionIndex],
                    feedback_id: feedbackId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Feedback rejected!', 'info');
                    updateFeedbackStatus(feedbackId, 'rejected');
                    updateStatistics();
                } else {
                    showNotification(data.error || 'Reject failed', 'error');
                }
            })
            .catch(error => {
                showNotification('Reject failed: ' + error.message, 'error');
            });
        }

        function updateFeedbackStatus(feedbackId, status) {
            const feedbackItem = document.querySelector(`[data-feedback-id="${feedbackId}"]`);
            if (feedbackItem) {
                const actions = feedbackItem.querySelector('.feedback-actions');
                const statusColor = status === 'accepted' ? '#2ecc71' : '#e74c3c';
                const statusText = status === 'accepted' ? '‚úì Accepted' : '‚úó Rejected';
                
                if (!feedbackStates[feedbackId]) {
                    feedbackStates[feedbackId] = {
                        originalHtml: actions.innerHTML,
                        status: 'pending'
                    };
                }
                feedbackStates[feedbackId].status = status;
                
                actions.innerHTML = `
                    <span style="color: ${statusColor}; font-weight: bold;">${statusText}</span>
                    <button class="btn btn-warning" onclick="revertFeedback('${feedbackId}', event)" style="font-size: 12px; padding: 5px 10px; margin-left: 10px;">üîÑ Revert</button>
                `;
                feedbackItem.style.opacity = '0.7';
            }
        }
        
        function revertFeedback(feedbackId, event) {
            if (event) event.stopPropagation();
            
            const feedbackItem = document.querySelector(`[data-feedback-id="${feedbackId}"]`);
            if (feedbackItem && feedbackStates[feedbackId]) {
                const actions = feedbackItem.querySelector('.feedback-actions');
                actions.innerHTML = feedbackStates[feedbackId].originalHtml;
                feedbackItem.style.opacity = '1';
                
                feedbackStates[feedbackId].status = 'pending';
                
                showNotification('Feedback reverted to original state', 'info');
                updateStatistics();
            }
        }
        
        function zoomIn() {
            if (documentZoom < 200) {
                documentZoom += 25;
                applyZoom();
            }
        }
        
        function zoomOut() {
            if (documentZoom > 50) {
                documentZoom -= 25;
                applyZoom();
            }
        }
        
        function resetZoom() {
            documentZoom = 100;
            applyZoom();
        }
        
        function applyZoom() {
            const docContent = document.getElementById('documentContent');
            const zoomLevel = document.getElementById('zoomLevel');
            
            if (docContent) {
                docContent.style.transform = `scale(${documentZoom / 100})`;
                docContent.style.transformOrigin = 'top left';
                docContent.style.width = `${10000 / documentZoom}%`;
            }
            
            if (zoomLevel) {
                zoomLevel.textContent = `${documentZoom}%`;
            }
        }

        function addCustomFeedback() {
            const type = document.getElementById('customType').value;
            const category = document.getElementById('customCategory').value;
            const description = document.getElementById('customDescription').value.trim();
            
            if (!description) {
                showNotification('Please enter feedback description', 'error');
                return;
            }
            
            const feedbackItem = {
                type: type,
                category: category,
                description: description,
                section: sections[currentSectionIndex],
                timestamp: new Date().toISOString(),
                session_id: currentSession,
                user_created: true,
                id: `user_${Date.now()}`
            };
            
            // Store in user feedback history for training
            userFeedbackHistory.push(feedbackItem);
            
            fetch('/add_custom_feedback', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    session_id: currentSession,
                    section_name: sections[currentSectionIndex],
                    type: type,
                    category: category,
                    description: description
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Custom feedback added!', 'success');
                    document.getElementById('customDescription').value = '';
                    document.getElementById('suggestionDropdown').style.display = 'none';
                    
                    // Display the user feedback immediately
                    displayUserFeedback(feedbackItem);
                    updateStatistics();
                    
                    // Update dashboard data
                    dashboardData.userFeedback++;
                    dashboardData.totalFeedback++;
                } else {
                    showNotification(data.error || 'Add feedback failed', 'error');
                }
            })
            .catch(error => {
                showNotification('Add feedback failed: ' + error.message, 'error');
            });
        }
        
        function displayUserFeedback(feedbackItem) {
            const container = document.getElementById('userFeedbackDisplay');
            
            const feedbackDiv = document.createElement('div');
            feedbackDiv.className = 'feedback-item user-feedback';
            feedbackDiv.style.background = '#e8f5e8';
            feedbackDiv.style.borderLeft = '4px solid #2ecc71';
            feedbackDiv.id = `user-feedback-${feedbackItem.id}`;
            
            const typeClass = `type-${feedbackItem.type}`;
            const timestamp = new Date(feedbackItem.timestamp).toLocaleTimeString();
            
            feedbackDiv.innerHTML = `
                <div class="feedback-header">
                    <div class="feedback-meta">
                        <span class="feedback-type ${typeClass}">${feedbackItem.type}</span>
                        <span style="color: #2ecc71; font-weight: bold;">üë§ Your Feedback</span>
                        <span style="color: #7f8c8d; font-size: 0.9em;">${feedbackItem.category}</span>
                        <span style="color: #7f8c8d; font-size: 0.8em;">${timestamp}</span>
                    </div>
                    <div>
                        <button class="btn btn-warning" onclick="editUserFeedback('${feedbackItem.id}')" style="font-size: 10px; padding: 3px 8px;">‚úèÔ∏è Edit</button>
                        <button class="btn btn-danger" onclick="deleteUserFeedback('${feedbackItem.id}')" style="font-size: 10px; padding: 3px 8px;">üóëÔ∏è Delete</button>
                    </div>
                </div>
                <p><strong>Your Input:</strong> ${feedbackItem.description}</p>
                ${feedbackItem.ai_reference ? `<p><strong>Related to AI:</strong> ${feedbackItem.ai_reference}</p>` : ''}
                <div style="margin-top: 10px; padding: 8px; background: rgba(46, 204, 113, 0.1); border-radius: 5px; font-size: 0.9em; color: #27ae60;">
                    ‚úÖ This feedback has been recorded and will be included in the final document.
                </div>
            `;
            
            container.appendChild(feedbackDiv);
            
            // Also add to all custom feedback list
            updateAllCustomFeedbackList();
            
            // Scroll to show the new feedback
            feedbackDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        function addCustomToAI(aiId, event) {
            if (event) event.stopPropagation();
            
            const customDiv = document.getElementById(`custom-${aiId}`);
            if (customDiv.style.display === 'none') {
                // Hide all other custom forms
                document.querySelectorAll('.ai-custom-feedback').forEach(div => {
                    div.style.display = 'none';
                });
                customDiv.style.display = 'block';
            } else {
                customDiv.style.display = 'none';
            }
        }
        
        function cancelAICustom(aiId) {
            document.getElementById(`custom-${aiId}`).style.display = 'none';
            document.getElementById(`aiCustomDesc-${aiId}`).value = '';
        }
        
        function saveAICustomFeedback(aiId) {
            const type = document.getElementById(`aiCustomType-${aiId}`).value;
            const category = document.getElementById(`aiCustomCategory-${aiId}`).value;
            const description = document.getElementById(`aiCustomDesc-${aiId}`).value.trim();
            
            if (!description) {
                showNotification('Please enter your custom feedback', 'error');
                return;
            }
            
            // Find the AI feedback item for reference
            const aiItem = window.sectionData?.[sections[currentSectionIndex]]?.feedback?.find(item => item.id === aiId);
            const aiReference = aiItem ? `${aiItem.type}: ${aiItem.description.substring(0, 50)}...` : 'AI Suggestion';
            
            fetch('/add_custom_feedback', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    session_id: currentSession,
                    section_name: sections[currentSectionIndex],
                    type: type,
                    category: category,
                    description: description,
                    ai_reference: aiReference,
                    ai_id: aiId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Custom feedback added to AI suggestion!', 'success');
                    
                    // Add to local history
                    const feedbackItem = data.feedback_item;
                    feedbackItem.section = sections[currentSectionIndex];
                    userFeedbackHistory.push(feedbackItem);
                    
                    displayUserFeedback(feedbackItem);
                    cancelAICustom(aiId);
                    updateStatistics();
                    updateAllCustomFeedbackList();
                } else {
                    showNotification(data.error || 'Add feedback failed', 'error');
                }
            })
            .catch(error => {
                showNotification('Add feedback failed: ' + error.message, 'error');
            });
        }
        
        function updateAllCustomFeedbackList() {
            const container = document.getElementById('customFeedbackList');
            if (!container) return;
            
            const currentSectionName = sections[currentSectionIndex];
            const allFeedback = userFeedbackHistory.filter(item => item.section === currentSectionName);
            
            if (allFeedback.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px; color: #666; border: 2px dashed #ddd;"><p style="margin: 0; font-style: italic;">No custom feedback for this section yet.</p><p style="margin: 5px 0 0 0; font-size: 0.9em;">Add your first feedback above!</p></div>';
                return;
            }
            
            // Sort by timestamp (newest first)
            allFeedback.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            container.innerHTML = allFeedback.map((item, index) => {
                const timestamp = new Date(item.timestamp).toLocaleTimeString();
                const typeColors = {
                    'addition': '#3498db',
                    'clarification': '#f39c12', 
                    'disagreement': '#e74c3c',
                    'enhancement': '#9b59b6',
                    'alternative': '#1abc9c',
                    'context': '#34495e',
                    'suggestion': '#2ecc71',
                    'important': '#f39c12',
                    'critical': '#e74c3c',
                    'positive': '#27ae60'
                };
                const typeColor = typeColors[item.type] || '#95a5a6';
                
                return `
                    <div style="background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); padding: 12px; margin: 8px 0; border-radius: 8px; border-left: 4px solid ${typeColor}; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.2s ease;" onmouseover="this.style.transform='translateX(5px)'" onmouseout="this.style.transform='translateX(0)'">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div>
                                <span style="background: ${typeColor}; color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.75em; font-weight: 600; text-transform: uppercase;">${item.type}</span>
                                <span style="color: #7f8c8d; font-size: 0.8em; margin-left: 8px;">üï∞Ô∏è ${timestamp}</span>
                                ${item.edited ? '<span style="color: #f39c12; font-size: 0.7em; margin-left: 5px;">‚úèÔ∏è Edited</span>' : ''}
                            </div>
                            <div>
                                <button onclick="editUserFeedback('${item.id}')" style="background: none; border: none; color: #f39c12; cursor: pointer; font-size: 14px; padding: 2px; margin: 0 2px;" title="Edit feedback">‚úèÔ∏è</button>
                                <button onclick="deleteUserFeedback('${item.id}')" style="background: none; border: none; color: #e74c3c; cursor: pointer; font-size: 14px; padding: 2px; margin: 0 2px;" title="Delete feedback">üóëÔ∏è</button>
                            </div>
                        </div>
                        <div style="font-size: 0.9em; color: #2c3e50; line-height: 1.4; margin-bottom: 5px;">${item.description}</div>
                        ${item.ai_reference ? `<div style="background: #e8f4fd; padding: 6px 10px; border-radius: 5px; font-size: 0.8em; color: #2980b9; border-left: 3px solid #3498db; margin-top: 8px;"><strong>ü§ñ AI Context:</strong> ${item.ai_reference}</div>` : ''}
                        <div style="font-size: 0.75em; color: #95a5a6; margin-top: 5px;">
                            üìÅ ${item.category} | #${index + 1}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function editUserFeedback(feedbackId) {
            const feedback = userFeedbackHistory.find(item => item.id === feedbackId);
            if (!feedback) return;
            
            const modalContent = `
                <div style="padding: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 20px;">‚úèÔ∏è Edit Your Feedback</h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label style="font-weight: bold; margin-bottom: 5px; display: block;">Type:</label>
                            <select id="editType" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="suggestion" ${feedback.type === 'suggestion' ? 'selected' : ''}>Suggestion</option>
                                <option value="important" ${feedback.type === 'important' ? 'selected' : ''}>Important</option>
                                <option value="critical" ${feedback.type === 'critical' ? 'selected' : ''}>Critical</option>
                                <option value="positive" ${feedback.type === 'positive' ? 'selected' : ''}>Positive</option>
                                <option value="addition" ${feedback.type === 'addition' ? 'selected' : ''}>Addition</option>
                                <option value="clarification" ${feedback.type === 'clarification' ? 'selected' : ''}>Clarification</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-weight: bold; margin-bottom: 5px; display: block;">Category:</label>
                            <select id="editCategory" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="Initial Assessment" ${feedback.category === 'Initial Assessment' ? 'selected' : ''}>Initial Assessment</option>
                                <option value="Investigation Process" ${feedback.category === 'Investigation Process' ? 'selected' : ''}>Investigation Process</option>
                                <option value="Root Cause Analysis" ${feedback.category === 'Root Cause Analysis' ? 'selected' : ''}>Root Cause Analysis</option>
                                <option value="Documentation and Reporting" ${feedback.category === 'Documentation and Reporting' ? 'selected' : ''}>Documentation and Reporting</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="font-weight: bold; margin-bottom: 5px; display: block;">Your Feedback:</label>
                        <textarea id="editDescription" style="width: 100%; height: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">${feedback.description}</textarea>
                    </div>
                    
                    ${feedback.ai_reference ? `<div style="background: #f0f8ff; padding: 10px; border-radius: 5px; margin-bottom: 15px;"><strong>Related to AI:</strong> ${feedback.ai_reference}</div>` : ''}
                    
                    <div style="text-align: center;">
                        <button class="btn btn-success" onclick="saveEditedFeedback('${feedbackId}')" style="margin: 5px;">‚úì Save Changes</button>
                        <button class="btn btn-secondary" onclick="closeModal('genericModal')" style="margin: 5px;">‚úó Cancel</button>
                    </div>
                </div>
            `;
            
            showModal('genericModal', 'Edit Feedback', modalContent);
        }
        
        function saveEditedFeedback(feedbackId) {
            const type = document.getElementById('editType').value;
            const category = document.getElementById('editCategory').value;
            const description = document.getElementById('editDescription').value.trim();
            
            if (!description) {
                showNotification('Please enter feedback description', 'error');
                return;
            }
            
            const updatedData = {
                type: type,
                category: category,
                description: description
            };
            
            fetch('/update_user_feedback', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    session_id: currentSession,
                    feedback_id: feedbackId,
                    updated_data: updatedData
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Feedback updated successfully!', 'success');
                    
                    // Update local history
                    const feedbackIndex = userFeedbackHistory.findIndex(item => item.id === feedbackId);
                    if (feedbackIndex !== -1) {
                        Object.assign(userFeedbackHistory[feedbackIndex], updatedData);
                        userFeedbackHistory[feedbackIndex].edited = true;
                        userFeedbackHistory[feedbackIndex].edited_at = new Date().toISOString();
                        
                        // Update display
                        const feedbackDiv = document.getElementById(`user-feedback-${feedbackId}`);
                        if (feedbackDiv) {
                            feedbackDiv.remove();
                            displayUserFeedback(userFeedbackHistory[feedbackIndex]);
                        }
                    }
                    
                    updateAllCustomFeedbackList();
                    closeModal('genericModal');
                    
                    // Refresh manager if open
                    const modal = document.getElementById('genericModal');
                    if (modal.style.display === 'block' && document.getElementById('genericModalTitle').textContent.includes('Feedback Manager')) {
                        setTimeout(() => refreshUserFeedbackManager(), 500);
                    }
                } else {
                    showNotification(data.error || 'Update failed', 'error');
                }
            })
            .catch(error => {
                showNotification('Update failed: ' + error.message, 'error');
            });
        }
        
        function deleteUserFeedback(feedbackId) {
            if (confirm('Are you sure you want to delete this feedback?')) {
                fetch('/delete_user_feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSession,
                        feedback_id: feedbackId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('Feedback deleted successfully!', 'success');
                        
                        // Remove from local history
                        const feedbackIndex = userFeedbackHistory.findIndex(item => item.id === feedbackId);
                        if (feedbackIndex !== -1) {
                            userFeedbackHistory.splice(feedbackIndex, 1);
                        }
                        
                        // Remove from display
                        const feedbackDiv = document.getElementById(`user-feedback-${feedbackId}`);
                        if (feedbackDiv) {
                            feedbackDiv.remove();
                        }
                        
                        updateAllCustomFeedbackList();
                        updateStatistics();
                    } else {
                        showNotification(data.error || 'Delete failed', 'error');
                    }
                })
                .catch(error => {
                    showNotification('Delete failed: ' + error.message, 'error');
                });
            }
        }
        
        function showUserFeedbackManager() {
            if (!currentSession) {
                showNotification('No active session', 'error');
                return;
            }
            
            // Fetch latest user feedback from server
            fetch(`/get_user_feedback?session_id=${currentSession}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const allFeedback = data.user_feedback;
                    
                    const modalContent = `
                        <div style="max-height: 75vh; overflow-y: auto;">
                            <h3 style="color: #667eea; margin-bottom: 20px;">üìù User Feedback Manager</h3>
                            
                            <div style="background: linear-gradient(135deg, #f8f9ff 0%, #e3f2fd 100%); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #667eea;">
                                <h4 style="color: #667eea; margin-bottom: 15px;">üìà Summary Dashboard</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                                    <div style="text-align: center; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                        <div style="font-size: 2em; font-weight: bold; color: #667eea;">${allFeedback.length}</div>
                                        <div style="color: #666; font-size: 0.9em;">Total Feedback</div>
                                    </div>
                                    <div style="text-align: center; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                        <div style="font-size: 2em; font-weight: bold; color: #2ecc71;">${data.sections_with_feedback}</div>
                                        <div style="color: #666; font-size: 0.9em;">Sections</div>
                                    </div>
                                    <div style="text-align: center; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                        <div style="font-size: 2em; font-weight: bold; color: #3498db;">${allFeedback.filter(f => f.ai_reference).length}</div>
                                        <div style="color: #666; font-size: 0.9em;">AI-Related</div>
                                    </div>
                                    <div style="text-align: center; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                        <div style="font-size: 2em; font-weight: bold; color: #f39c12;">${allFeedback.filter(f => f.edited).length}</div>
                                        <div style="color: #666; font-size: 0.9em;">Edited</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 20px; text-align: center;">
                                <button class="btn btn-primary" onclick="exportAllUserFeedback('json')" style="margin: 5px;">üìÑ Export JSON</button>
                                <button class="btn btn-success" onclick="exportAllUserFeedback('csv')" style="margin: 5px;">üìÖ Export CSV</button>
                                <button class="btn btn-info" onclick="exportAllUserFeedback('txt')" style="margin: 5px;">üìù Export Text</button>
                                <button class="btn btn-warning" onclick="refreshUserFeedbackManager()" style="margin: 5px;">üîÑ Refresh</button>
                                <button class="btn btn-danger" onclick="clearAllUserFeedback()" style="margin: 5px;">üóëÔ∏è Clear All</button>
                            </div>
                            
                            <div id="feedbackManagerList">
                                ${allFeedback.length === 0 ? '<div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 10px; color: #666;"><h4>No feedback added yet</h4><p>Start adding custom feedback to see it here!</p></div>' : 
                                allFeedback.map((item, index) => {
                                    const timestamp = new Date(item.timestamp).toLocaleString();
                                    const typeColors = {
                                        'addition': '#3498db',
                                        'clarification': '#f39c12', 
                                        'disagreement': '#e74c3c',
                                        'enhancement': '#9b59b6',
                                        'alternative': '#1abc9c',
                                        'context': '#34495e',
                                        'suggestion': '#2ecc71',
                                        'important': '#f39c12',
                                        'critical': '#e74c3c',
                                        'positive': '#27ae60'
                                    };
                                    const typeColor = typeColors[item.type] || '#95a5a6';
                                    
                                    return `
                                        <div style="background: white; padding: 20px; margin: 15px 0; border-radius: 12px; border-left: 5px solid ${typeColor}; box-shadow: 0 3px 15px rgba(0,0,0,0.1); transition: transform 0.2s ease;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                                                <div style="flex: 1;">
                                                    <div style="margin-bottom: 8px;">
                                                        <span style="background: ${typeColor}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.8em; font-weight: 600; text-transform: uppercase;">${item.type}</span>
                                                        <span style="background: #ecf0f1; color: #2c3e50; padding: 4px 12px; border-radius: 20px; font-size: 0.8em; margin-left: 8px;">${item.category}</span>
                                                        <span style="color: #7f8c8d; font-size: 0.8em; margin-left: 10px; font-weight: 500;">üìÅ ${item.section}</span>
                                                    </div>
                                                    <div style="color: #95a5a6; font-size: 0.8em;">
                                                        üï∞Ô∏è ${timestamp}
                                                        ${item.edited ? ` | ‚úèÔ∏è Edited: ${new Date(item.edited_at).toLocaleString()}` : ''}
                                                    </div>
                                                </div>
                                                <div style="display: flex; gap: 8px;">
                                                    <button onclick="editUserFeedbackInManager('${item.id}')" style="background: #f39c12; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; transition: background 0.2s;" onmouseover="this.style.background='#e67e22'" onmouseout="this.style.background='#f39c12'">‚úèÔ∏è Edit</button>
                                                    <button onclick="deleteUserFeedbackFromManager('${item.id}')" style="background: #e74c3c; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; transition: background 0.2s;" onmouseover="this.style.background='#c0392b'" onmouseout="this.style.background='#e74c3c'">üóëÔ∏è Delete</button>
                                                </div>
                                            </div>
                                            <div style="margin-bottom: 15px; color: #2c3e50; line-height: 1.6; background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 3px solid ${typeColor};">
                                                <strong>Feedback:</strong> ${item.description}
                                            </div>
                                            ${item.ai_reference ? `<div style="background: linear-gradient(135deg, #e8f4fd 0%, #d6eaf8 100%); padding: 12px; border-radius: 8px; font-size: 0.9em; color: #2980b9; border: 1px solid #aed6f1;"><strong>ü§ñ Related to AI Suggestion:</strong> ${item.ai_reference}</div>` : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                    
                    showModal('genericModal', 'User Feedback Manager', modalContent);
                } else {
                    showNotification('Failed to load user feedback: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                showNotification('Failed to load user feedback: ' + error.message, 'error');
            });
        }
        
        function updateFeedbackManagerList() {
            const container = document.getElementById('feedbackManagerList');
            if (container) {
                const allFeedback = userFeedbackHistory;
                container.innerHTML = allFeedback.length === 0 ? '<p style="text-align: center; color: #666;">No feedback added yet.</p>' : 
                allFeedback.map(item => {
                    const timestamp = new Date(item.timestamp).toLocaleString();
                    return `
                        <div style="background: white; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #3498db; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div>
                                    <span style="background: #3498db; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.8em;">${item.type}</span>
                                    <span style="background: #95a5a6; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.8em; margin-left: 5px;">${item.category}</span>
                                    <span style="color: #666; font-size: 0.8em; margin-left: 10px;">${item.section}</span>
                                </div>
                                <div>
                                    <button onclick="editUserFeedback('${item.id}')" style="background: #f39c12; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin: 2px;">‚úèÔ∏è Edit</button>
                                    <button onclick="deleteUserFeedback('${item.id}'); updateFeedbackManagerList();" style="background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin: 2px;">üóëÔ∏è Delete</button>
                                </div>
                            </div>
                            <div style="margin-bottom: 10px; color: #333;">${item.description}</div>
                            ${item.ai_reference ? `<div style="background: #ecf0f1; padding: 8px; border-radius: 4px; font-size: 0.9em; color: #666;"><strong>Related to AI:</strong> ${item.ai_reference}</div>` : ''}
                            <div style="font-size: 0.8em; color: #999; margin-top: 8px;">
                                Created: ${timestamp}
                                ${item.edited ? ` | Edited: ${new Date(item.editedAt).toLocaleString()}` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }
        
        function exportUserFeedbackCSV() {
            if (userFeedbackHistory.length === 0) {
                showNotification('No feedback to export', 'info');
                return;
            }
            
            const headers = ['Timestamp', 'Section', 'Type', 'Category', 'Description', 'AI Reference', 'Edited'];
            const csvContent = [headers.join(',')];
            
            userFeedbackHistory.forEach(item => {
                const row = [
                    new Date(item.timestamp).toLocaleString(),
                    item.section,
                    item.type,
                    item.category,
                    `"${item.description.replace(/"/g, '""')}"`,
                    item.ai_reference ? `"${item.ai_reference.replace(/"/g, '""')}"` : '',
                    item.edited ? 'Yes' : 'No'
                ];
                csvContent.push(row.join(','));
            });
            
            const blob = new Blob([csvContent.join('\n')], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `User_Feedback_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showNotification('Feedback exported as CSV!', 'success');
        }
        
        function clearAllUserFeedback() {
            if (confirm('Are you sure you want to delete ALL your feedback? This cannot be undone.')) {
                userFeedbackHistory.length = 0;
                document.getElementById('userFeedbackDisplay').innerHTML = '';
                updateAllCustomFeedbackList();
                showNotification('All feedback cleared!', 'success');
                
                // Refresh manager if open
                const modal = document.getElementById('genericModal');
                if (modal.style.display === 'block' && document.getElementById('genericModalTitle').textContent.includes('Feedback Manager')) {
                    refreshUserFeedbackManager();
                }
            }
        }
        
        function refreshUserFeedbackManager() {
            closeModal('genericModal');
            setTimeout(() => showUserFeedbackManager(), 100);
        }
        
        function editUserFeedbackInManager(feedbackId) {
            editUserFeedback(feedbackId);
        }
        
        function deleteUserFeedbackFromManager(feedbackId) {
            if (confirm('Are you sure you want to delete this feedback?')) {
                fetch('/delete_user_feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSession,
                        feedback_id: feedbackId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('Feedback deleted successfully!', 'success');
                        
                        // Remove from local history
                        const index = userFeedbackHistory.findIndex(item => item.id === feedbackId);
                        if (index !== -1) {
                            userFeedbackHistory.splice(index, 1);
                        }
                        
                        // Remove from display
                        const feedbackDiv = document.getElementById(`user-feedback-${feedbackId}`);
                        if (feedbackDiv) {
                            feedbackDiv.remove();
                        }
                        
                        updateAllCustomFeedbackList();
                        refreshUserFeedbackManager();
                    } else {
                        showNotification(data.error || 'Delete failed', 'error');
                    }
                })
                .catch(error => {
                    showNotification('Delete failed: ' + error.message, 'error');
                });
            }
        }
        
        function exportAllUserFeedback(format = 'json') {
            if (!currentSession) {
                showNotification('No active session', 'error');
                return;
            }
            
            window.location.href = `/export_user_feedback?session_id=${currentSession}&format=${format}`;
            showNotification(`Exporting feedback as ${format.toUpperCase()}...`, 'info');
        }
        
        function refreshUserFeedbackList() {
            if (currentSession) {
                loadUserFeedbackForSection(sections[currentSectionIndex]);
                updateAllCustomFeedbackList();
                showNotification('Feedback list refreshed!', 'success');
            }
        }

        function updateRiskIndicator(feedbackItems) {
            const indicator = document.getElementById('riskIndicator');
            
            if (!feedbackItems || feedbackItems.length === 0) {
                indicator.className = 'risk-indicator risk-low';
                indicator.textContent = '‚úì No Issues';
                return;
            }
            
            const highRisk = feedbackItems.filter(item => item.risk_level === 'High').length;
            const mediumRisk = feedbackItems.filter(item => item.risk_level === 'Medium').length;
            
            if (highRisk > 0) {
                indicator.className = 'risk-indicator risk-high';
                indicator.textContent = `‚ö†Ô∏è High Risk (${highRisk} issues)`;
            } else if (mediumRisk > 0) {
                indicator.className = 'risk-indicator risk-medium';
                indicator.textContent = `‚ö†Ô∏è Medium Risk (${mediumRisk} issues)`;
            } else {
                indicator.className = 'risk-indicator risk-low';
                indicator.textContent = '‚úì Low Risk';
            }
        }

        function updateStatistics() {
            if (!currentSession) return;
            
            fetch(`/get_statistics?session_id=${currentSession}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayStatistics(data.statistics);
                }
            })
            .catch(error => {
                console.error('Failed to update statistics:', error);
            });
        }

        function displayStatistics(stats) {
            const container = document.getElementById('statsGrid');
            
            // Calculate percentages
            const total = stats.total_feedback || 1; // Avoid division by zero
            const acceptedPercent = ((stats.accepted || 0) / total * 100).toFixed(1);
            const highRiskPercent = ((stats.high_risk || 0) / total * 100).toFixed(1);
            const mediumRiskPercent = ((stats.medium_risk || 0) / total * 100).toFixed(1);
            const userAddedPercent = ((stats.user_added || 0) / total * 100).toFixed(1);
            
            container.innerHTML = `
                <div class="stat-item" onclick="showStatisticBreakdown('total_feedback')">
                    <div class="stat-number" style="color: #667eea;">${stats.total_feedback}</div>
                    <div class="stat-label">Total Feedback</div>
                    <div style="font-size: 0.8em; color: #95a5a6; margin-top: 5px;">100%</div>
                </div>
                <div class="stat-item" onclick="showStatisticBreakdown('high_risk')">
                    <div class="stat-number" style="color: #e74c3c;">${stats.high_risk}</div>
                    <div class="stat-label">High Risk</div>
                    <div style="font-size: 0.8em; color: #e74c3c; margin-top: 5px;">${highRiskPercent}%</div>
                </div>
                <div class="stat-item" onclick="showStatisticBreakdown('medium_risk')">
                    <div class="stat-number" style="color: #f39c12;">${stats.medium_risk}</div>
                    <div class="stat-label">Medium Risk</div>
                    <div style="font-size: 0.8em; color: #f39c12; margin-top: 5px;">${mediumRiskPercent}%</div>
                </div>
                <div class="stat-item" onclick="showStatisticBreakdown('accepted')">
                    <div class="stat-number" style="color: #2ecc71;">${stats.accepted}</div>
                    <div class="stat-label">Accepted</div>
                    <div style="font-size: 0.8em; color: #2ecc71; margin-top: 5px;">${acceptedPercent}%</div>
                </div>
                <div class="stat-item" onclick="showStatisticBreakdown('user_added')">
                    <div class="stat-number" style="color: #3498db;">${stats.user_added}</div>
                    <div class="stat-label">User Added</div>
                    <div style="font-size: 0.8em; color: #3498db; margin-top: 5px;">${userAddedPercent}%</div>
                </div>
            `;
        }

        function showStatisticBreakdown(statType) {
            if (!currentSession) {
                showNotification('No active session. Please upload a document first.', 'error');
                return;
            }
            
            fetch(`/get_statistics_breakdown?session_id=${currentSession}&stat_type=${statType}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const enhancedBreakdown = generateEnhancedBreakdown(data.breakdown, statType);
                    showModal('genericModal', `${statType.replace('_', ' ').toUpperCase()} - Detailed Analysis`, enhancedBreakdown);
                } else {
                    // Show fallback content when no data is available
                    const fallbackContent = generateEnhancedBreakdown(null, statType);
                    showModal('genericModal', `${statType.replace('_', ' ').toUpperCase()} - Detailed Analysis`, fallbackContent);
                }
            })
            .catch(error => {
                console.error('Statistics breakdown error:', error);
                const fallbackContent = generateEnhancedBreakdown(null, statType);
                showModal('genericModal', `${statType.replace('_', ' ').toUpperCase()} - Detailed Analysis`, fallbackContent);
            });
        }
        
        function generateEnhancedBreakdown(breakdown, statType) {
            // Handle undefined or null breakdown
            if (!breakdown) {
                return `
                    <div class="dashboard-card">
                        <h3 style="color: #667eea; margin-bottom: 20px;">üìä ${statType.replace('_', ' ').toUpperCase()} Analysis</h3>
                        <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 10px; color: #666;">
                            <h4>No Data Available</h4>
                            <p>No breakdown data found for ${statType.replace('_', ' ')}.</p>
                            <p>Upload and analyze a document to see detailed statistics.</p>
                        </div>
                    </div>
                `;
            }
            
            let html = `
                <div class="dashboard-card">
                    <h3 style="color: #667eea; margin-bottom: 20px;">üìä ${statType.replace('_', ' ').toUpperCase()} Analysis</h3>
                    
                    <div class="dashboard-grid">
                        <div class="dashboard-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <h4>Summary</h4>
                            <p>Total Items: <strong>${breakdown.total || 0}</strong></p>
                            <p>Sections Affected: <strong>${Object.keys(breakdown.by_section || {}).length}</strong></p>
                            <p>Categories: <strong>${Object.keys(breakdown.by_category || {}).length}</strong></p>
                        </div>
                        
                        <div class="dashboard-card">
                            <h4>By Section</h4>
                            <div style="max-height: 200px; overflow-y: auto;">
            `;
            
            if (breakdown.by_section) {
                Object.entries(breakdown.by_section).forEach(([section, count]) => {
                    const percentage = breakdown.total ? ((count / breakdown.total) * 100).toFixed(1) : 0;
                    html += `
                        <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee;">
                            <span>${section}</span>
                            <span><strong>${count}</strong> (${percentage}%)</span>
                        </div>
                    `;
                });
            }
            
            html += `
                            </div>
                        </div>
                        
                        <div class="dashboard-card">
                            <h4>By Type/Category</h4>
                            <div style="max-height: 200px; overflow-y: auto;">
            `;
            
            if (breakdown.by_type) {
                Object.entries(breakdown.by_type).forEach(([type, count]) => {
                    const color = type === 'critical' ? '#e74c3c' : type === 'important' ? '#f39c12' : '#3498db';
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 5px 0;">
                            <span style="color: ${color}; font-weight: bold;">${type.toUpperCase()}</span>
                            <span><strong>${count}</strong></span>
                        </div>
                    `;
                });
            }
            
            html += `
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h4>Recent Items</h4>
                        <div style="max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 8px;">
            `;
            
            if (breakdown.items && breakdown.items.length > 0) {
                breakdown.items.slice(0, 10).forEach((item, index) => {
                    html += `
                        <div style="margin-bottom: 15px; padding: 10px; background: white; border-radius: 5px; border-left: 4px solid #667eea;">
                            <div style="font-weight: bold; color: #667eea;">${item.section || 'Unknown Section'}</div>
                            <div style="margin: 5px 0; color: #666;">${item.description || 'No description available'}</div>
                            <div style="font-size: 0.8em; color: #999;">
                                Type: ${item.type || 'Unknown'} | 
                                Risk: ${item.risk_level || 'Unknown'}
                            </div>
                        </div>
                    `;
                });
            } else {
                html += '<p style="text-align: center; color: #666;">No items available for display</p>';
            }
            
            html += `
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-primary" onclick="exportStatistics('${statType}')">
                            üì• Export ${statType.replace('_', ' ')} Data
                        </button>
                    </div>
                </div>
            `;
            
            return html;
        }

        function previousSection() {
            if (currentSectionIndex > 0) {
                loadSection(currentSectionIndex - 1);
            }
        }

        function nextSection() {
            if (currentSectionIndex < sections.length - 1) {
                loadSection(currentSectionIndex + 1);
            }
        }

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`.tab:nth-child(${tabName === 'feedback' ? '1' : '2'})`).classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}Tab`).classList.add('active');
        }
        
        function toggleAIPrismChat() {
            const chatContent = document.getElementById('aiPrismChatContent');
            if (chatContent.style.display === 'none') {
                chatContent.style.display = 'flex';
                chatContent.style.flexDirection = 'column';
            } else {
                chatContent.style.display = 'none';
            }
        }

        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message to chat
            addChatMessage(message, 'user');
            input.value = '';
            
            // Add thinking message
            addChatMessage('ü§î Thinking...', 'assistant', true);
            
            sendChatWithFallback(message, 0);
        }
        
        function sendChatWithFallback(message, modelIndex) {
            const modelToUse = modelFallbackOrder[modelIndex] || currentAIModel;
            
            fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    session_id: currentSession,
                    message: message,
                    current_section: sections[currentSectionIndex],
                    ai_model: modelToUse
                })
            })
            .then(response => response.json())
            .then(data => {
                // Remove thinking message
                const thinkingMessage = document.querySelector('.chat-message.thinking');
                if (thinkingMessage) {
                    thinkingMessage.remove();
                }
                
                if (data.success) {
                    addChatMessage(data.response, 'assistant', false, modelToUse);
                } else if (modelIndex < modelFallbackOrder.length - 1) {
                    // Try next model in fallback order
                    showNotification(`${availableModels[modelToUse]} failed, trying ${availableModels[modelFallbackOrder[modelIndex + 1]]}...`, 'info');
                    addChatMessage('ü§î Switching to backup AI model...', 'assistant', true);
                    setTimeout(() => sendChatWithFallback(message, modelIndex + 1), 1000);
                } else {
                    addChatMessage('Sorry, all AI models are currently unavailable. Please try again later.', 'assistant');
                }
            })
            .catch(error => {
                if (modelIndex < modelFallbackOrder.length - 1) {
                    // Try next model in fallback order
                    showNotification(`Connection failed, trying backup AI model...`, 'info');
                    const thinkingMessage = document.querySelector('.chat-message.thinking');
                    if (thinkingMessage) {
                        thinkingMessage.innerHTML = '<strong>ü§ñ AI-Prism:</strong><br>ü§î Switching to backup AI model...';
                    }
                    setTimeout(() => sendChatWithFallback(message, modelIndex + 1), 1000);
                } else {
                    const thinkingMessage = document.querySelector('.chat-message.thinking');
                    if (thinkingMessage) {
                        thinkingMessage.remove();
                    }
                    addChatMessage('Sorry, all AI models are currently unavailable. Please try again later.', 'assistant');
                }
            });
        }
        
        function changeAIModel() {
            const select = document.getElementById('aiModelSelect');
            currentAIModel = select.value;
            currentModelIndex = modelFallbackOrder.indexOf(currentAIModel);
            
            showNotification(`Switched to ${availableModels[currentAIModel]}`, 'success');
            
            // Update chat header
            const lastMessage = document.querySelector('.chat-message.assistant:last-of-type');
            if (lastMessage) {
                const modelName = availableModels[currentAIModel].split(' (')[0];
                addChatMessage(`I'm now using ${modelName}. How can I help you?`, 'assistant', false, currentAIModel);
            }
        }
        
        function testAIModel() {
            const testMessage = 'Hello, please confirm you are working properly.';
            addChatMessage('Testing AI model...', 'user');
            addChatMessage('ü§î Testing connection...', 'assistant', true);
            
            fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    session_id: currentSession,
                    message: testMessage,
                    current_section: sections[currentSectionIndex],
                    ai_model: currentAIModel
                })
            })
            .then(response => response.json())
            .then(data => {
                const thinkingMessage = document.querySelector('.chat-message.thinking');
                if (thinkingMessage) {
                    thinkingMessage.remove();
                }
                
                if (data.success) {
                    addChatMessage(`‚úÖ ${availableModels[currentAIModel]} is working properly!`, 'assistant', false, currentAIModel);
                } else {
                    addChatMessage(`‚ùå ${availableModels[currentAIModel]} test failed. Please try a different model.`, 'assistant');
                }
            })
            .catch(error => {
                const thinkingMessage = document.querySelector('.chat-message.thinking');
                if (thinkingMessage) {
                    thinkingMessage.remove();
                }
                addChatMessage(`‚ùå ${availableModels[currentAIModel]} connection failed.`, 'assistant');
            });
        }
        
        function regenerateResponse() {
            const chatMessages = document.querySelectorAll('.chat-message.user');
            if (chatMessages.length === 0) {
                showNotification('No previous message to regenerate', 'info');
                return;
            }
            
            const lastUserMessage = chatMessages[chatMessages.length - 1];
            const messageText = lastUserMessage.textContent.replace('You:', '').trim();
            
            // Remove last assistant response
            const assistantMessages = document.querySelectorAll('.chat-message.assistant');
            if (assistantMessages.length > 1) { // Keep the welcome message
                assistantMessages[assistantMessages.length - 1].remove();
            }
            
            // Regenerate with current model
            addChatMessage('ü§î Regenerating response...', 'assistant', true);
            sendChatWithFallback(messageText, currentModelIndex);
        }

        function addChatMessage(message, sender, isThinking = false, aiModel = null) {
            const container = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}${isThinking ? ' thinking' : ''}`;
            
            const timestamp = new Date().toLocaleTimeString();
            
            if (sender === 'user') {
                messageDiv.innerHTML = `<strong>üë§ You:</strong> <small style="opacity: 0.7;">${timestamp}</small><br>${message}`;
                messageDiv.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                messageDiv.style.color = 'white';
                messageDiv.style.borderRadius = '12px';
                messageDiv.style.padding = '15px';
                messageDiv.style.margin = '10px';
                messageDiv.style.boxShadow = '0 3px 10px rgba(16, 185, 129, 0.3)';
                // Store in chat history
                if (!isThinking) {
                    chatHistory.push({ role: 'user', content: message, timestamp: timestamp });
                }
            } else {
                const modelName = aiModel ? availableModels[aiModel].split(' (')[0] : 'AI-Prism';
                messageDiv.innerHTML = `<strong>AI-Prism:</strong> <small style="opacity: 0.7;">${timestamp}</small><br>${message}`;
                messageDiv.style.background = 'linear-gradient(135deg, #6b7280, #4b5563)';
                messageDiv.style.color = 'white';
                messageDiv.style.borderRadius = '12px';
                messageDiv.style.padding = '15px';
                messageDiv.style.margin = '10px';
                messageDiv.style.boxShadow = '0 3px 10px rgba(107, 114, 128, 0.3)';
                if (!isThinking) {
                    // Store in chat history
                    chatHistory.push({ role: 'assistant', content: message, timestamp: timestamp, model: aiModel });
                }
            }
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }



        function downloadDocument() {
            const filename = document.getElementById('downloadBtn').getAttribute('data-filename');
            if (filename) {
                window.location.href = `/download/${filename}`;
            } else {
                showNotification('No document available for download', 'error');
            }
        }
        
        function downloadStatistics() {
            if (!currentSession) {
                showNotification('No active session', 'error');
                return;
            }
            
            // Show format selection modal
            const modalContent = `
                <div style="text-align: center; padding: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 20px;">üìä Download Statistics</h3>
                    <p style="margin-bottom: 30px;">Choose the format for your statistics export:</p>
                    
                    <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="downloadStatsFormat('json')" style="padding: 15px 25px;">
                            üìÑ JSON Format
                        </button>
                        <button class="btn btn-success" onclick="downloadStatsFormat('csv')" style="padding: 15px 25px;">
                            üìÖ CSV Format
                        </button>
                        <button class="btn btn-info" onclick="downloadStatsFormat('txt')" style="padding: 15px 25px;">
                            üìù Text Format
                        </button>
                    </div>
                    
                    <p style="margin-top: 20px; font-size: 0.9em; color: #666;">
                        Statistics include feedback counts, risk levels, and section analysis.
                    </p>
                </div>
            `;
            
            showModal('genericModal', 'Download Statistics', modalContent);
        }
        
        function downloadStatsFormat(format) {
            closeModal('genericModal');
            window.location.href = `/download_statistics?session_id=${currentSession}&format=${format}`;
            showNotification(`Downloading statistics as ${format.toUpperCase()}...`, 'info');
        }

        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode', isDarkMode);
            
            const button = document.getElementById('darkModeToggle');
            if (button) {
                button.textContent = isDarkMode ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode';
                button.className = isDarkMode ? 'btn btn-warning' : 'btn btn-secondary';
            }
            
            // Save preference
            localStorage.setItem('darkMode', isDarkMode.toString());
        }

        function showShortcuts() {
            document.getElementById('shortcutsModal').style.display = 'block';
        }

        function showTutorial() {
            showModal('genericModal', 'üîç Interactive Tutorial', `
                <div>
                    <h4>Welcome to the Document Analysis Tool!</h4>
                    <p>This tool helps you review documents using the Hawkeye framework. Here's how to get started:</p>
                    
                    <ol>
                        <li><strong>Upload Document:</strong> Drag and drop or click to upload a .docx file</li>
                        <li><strong>Review Sections:</strong> Navigate through sections using the dropdown or arrow buttons</li>
                        <li><strong>Analyze Feedback:</strong> Review AI-generated feedback and accept/reject items</li>
                        <li><strong>Add Custom Feedback:</strong> Use the form to add your own insights</li>
                        <li><strong>Use Chat:</strong> Ask questions about feedback or guidelines</li>
                        <li><strong>Complete Review:</strong> Generate final document with comments</li>
                    </ol>
                    
                    <p><strong>Pro Tips:</strong></p>
                    <ul>
                        <li>Use keyboard shortcuts for faster navigation (press ? to see all shortcuts)</li>
                        <li>Click on statistics numbers to see detailed breakdowns</li>
                        <li>The AI learns from your feedback patterns over time</li>
                        <li>Toggle dark mode for comfortable viewing</li>
                    </ul>
                </div>
            `);
        }

        function showFAQ() {
            document.getElementById('faqModal').style.display = 'block';
        }

        function showPatterns() {
            if (!currentSession) {
                showNotification('No active session', 'error');
                return;
            }
            
            fetch(`/get_patterns?session_id=${currentSession}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let html = `
                        <div style="max-height: 70vh; overflow-y: auto;">
                            <h3 style="color: #667eea; margin-bottom: 20px;">üìä Pattern Analysis Dashboard</h3>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                                    <div style="font-size: 2em; font-weight: bold;">${data.patterns.recurring_patterns.length}</div>
                                    <div>Recurring Patterns</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                                    <div style="font-size: 2em; font-weight: bold;">${Object.keys(data.patterns.section_analysis || {}).length}</div>
                                    <div>Sections Analyzed</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                                    <div style="font-size: 2em; font-weight: bold;">${Object.keys(data.patterns.category_trends || {}).length}</div>
                                    <div>Categories Found</div>
                                </div>
                            </div>
                    `;
                    
                    if (data.patterns.recurring_patterns.length === 0) {
                        html += '<div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 10px; color: #666;"><h4>No Recurring Patterns Found</h4><p>Continue analyzing more sections to identify patterns across your document.</p></div>';
                    } else {
                        html += '<h4>üîç Recurring Patterns Identified:</h4>';
                        
                        data.patterns.recurring_patterns.forEach((pattern, index) => {
                            html += `
                                <div style="margin: 15px 0; padding: 20px; border-left: 4px solid #667eea; background: #f8f9ff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                    <h5 style="color: #667eea; margin-bottom: 10px;">Pattern #${index + 1}: ${pattern.category}</h5>
                                    <p><strong>Description:</strong> ${pattern.pattern}</p>
                                    <p><strong>Sections Affected:</strong> ${pattern.occurrence_count} sections</p>
                                    <p><strong>Affected Sections:</strong> ${pattern.sections_affected ? pattern.sections_affected.join(', ') : 'Multiple sections'}</p>
                                    <details style="margin-top: 10px;">
                                        <summary style="cursor: pointer; font-weight: bold; color: #667eea;">View Examples</summary>
                                        <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 5px;">
                                            ${pattern.examples.map(ex => `
                                                <div style="margin: 8px 0; padding: 8px; border-left: 3px solid ${ex.risk_level === 'High' ? '#e74c3c' : ex.risk_level === 'Medium' ? '#f39c12' : '#2ecc71'}; background: #fafafa;">
                                                    <strong>${ex.section || ex.document}:</strong> 
                                                    <span style="color: ${ex.risk_level === 'High' ? '#e74c3c' : ex.risk_level === 'Medium' ? '#f39c12' : '#2ecc71'}; font-weight: bold;">
                                                        ${ex.risk_level} Risk
                                                    </span><br>
                                                    <em>${ex.description}</em>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </details>
                                </div>
                            `;
                        });
                    }
                    
                    // Add risk distribution if available
                    if (data.patterns.risk_distribution) {
                        html += `
                            <h4>‚ö†Ô∏è Risk Distribution:</h4>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px 0;">
                                <div style="text-align: center; padding: 15px; background: #ffeaea; border-radius: 8px;">
                                    <div style="font-size: 1.5em; font-weight: bold; color: #e74c3c;">${data.patterns.risk_distribution.High || 0}</div>
                                    <div>High Risk</div>
                                </div>
                                <div style="text-align: center; padding: 15px; background: #fff3cd; border-radius: 8px;">
                                    <div style="font-size: 1.5em; font-weight: bold; color: #f39c12;">${data.patterns.risk_distribution.Medium || 0}</div>
                                    <div>Medium Risk</div>
                                </div>
                                <div style="text-align: center; padding: 15px; background: #e8f5e8; border-radius: 8px;">
                                    <div style="font-size: 1.5em; font-weight: bold; color: #2ecc71;">${data.patterns.risk_distribution.Low || 0}</div>
                                    <div>Low Risk</div>
                                </div>
                            </div>
                        `;
                    }
                    
                    html += `
                            <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 2px solid #ecf0f1;">
                                <button class="btn btn-primary" onclick="exportPatterns()" style="margin: 5px;">
                                    üì• Export Pattern Analysis
                                </button>
                                <button class="btn btn-info" onclick="refreshPatterns()" style="margin: 5px;">
                                    üîÑ Refresh Analysis
                                </button>
                            </div>
                        </div>
                    `;
                    
                    showModal('genericModal', 'üìä Pattern Analysis', html);
                } else {
                    showNotification(data.error || 'Failed to load patterns', 'error');
                }
            })
            .catch(error => {
                showNotification('Failed to load patterns: ' + error.message, 'error');
            });
        }
        
        function exportPatterns() {
            if (!currentSession) {
                showNotification('No active session', 'error');
                return;
            }
            
            fetch(`/get_patterns?session_id=${currentSession}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const exportData = {
                        export_timestamp: new Date().toISOString(),
                        session_id: currentSession,
                        patterns: data.patterns
                    };
                    
                    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `patterns_analysis_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    showNotification('Pattern analysis exported successfully!', 'success');
                } else {
                    showNotification('Export failed: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                showNotification('Export failed: ' + error.message, 'error');
            });
        }
        
        function refreshPatterns() {
            closeModal('genericModal');
            setTimeout(() => showPatterns(), 100);
        }

        function showLogs() {
            if (!currentSession) {
                showNotification('No active session', 'error');
                return;
            }
            
            fetch(`/get_logs?session_id=${currentSession}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let html = '<h4>üìã Activity Logs</h4>';
                    html += '<div style="max-height: 400px; overflow-y: auto;">';
                    
                    if (data.logs.length === 0) {
                        html += '<p>No activity logs available.</p>';
                    } else {
                        html += '<table style="width: 100%; border-collapse: collapse;">';
                        html += '<tr><th style="text-align: left; padding: 8px; border-bottom: 1px solid #eee;">Time</th><th style="text-align: left; padding: 8px; border-bottom: 1px solid #eee;">Action</th><th style="text-align: left; padding: 8px; border-bottom: 1px solid #eee;">Details</th></tr>';
                        
                        data.logs.forEach(log => {
                            const time = new Date(log.timestamp).toLocaleTimeString();
                            html += `
                                <tr>
                                    <td style="padding: 8px; border-bottom: 1px solid #eee;">${time}</td>
                                    <td style="padding: 8px; border-bottom: 1px solid #eee;">${log.action}</td>
                                    <td style="padding: 8px; border-bottom: 1px solid #eee;">${log.details}</td>
                                </tr>
                            `;
                        });
                        
                        html += '</table>';
                    }
                    
                    html += '</div>';
                    showModal('genericModal', 'üìã Activity Logs', html);
                } else {
                    showNotification(data.error || 'Failed to load logs', 'error');
                }
            })
            .catch(error => {
                showNotification('Failed to load logs: ' + error.message, 'error');
            });
        }

        function showLearning() {
            if (!currentSession) {
                showNotification('No active session', 'error');
                return;
            }
            
            fetch(`/get_learning_status?session_id=${currentSession}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const status = data.learning_status;
                    
                    let html = `
                        <div style="max-height: 70vh; overflow-y: auto;">
                            <h3 style="color: #667eea; margin-bottom: 20px;">üß† AI Learning System Dashboard</h3>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                                    <div style="font-size: 2em; font-weight: bold;">${status.total_ai_feedback || 0}</div>
                                    <div style="font-size: 0.9em;">AI Feedback Items</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                                    <div style="font-size: 2em; font-weight: bold;">${status.accepted_feedback_count || 0}</div>
                                    <div style="font-size: 0.9em;">Accepted</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                                    <div style="font-size: 2em; font-weight: bold;">${status.rejected_feedback_count || 0}</div>
                                    <div style="font-size: 0.9em;">Rejected</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                                    <div style="font-size: 2em; font-weight: bold;">${status.custom_feedback_count || 0}</div>
                                    <div style="font-size: 0.9em;">User Added</div>
                                </div>
                            </div>
                            
                            <div style="background: linear-gradient(135deg, #f8f9ff 0%, #e3f2fd 100%); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #667eea;">
                                <h4 style="color: #667eea; margin-bottom: 15px;">üìà Learning Performance</h4>
                                <div style="margin-bottom: 15px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                        <span>Acceptance Rate</span>
                                        <span style="font-weight: bold; color: ${status.acceptance_rate > 70 ? '#2ecc71' : status.acceptance_rate > 40 ? '#f39c12' : '#e74c3c'};">${status.acceptance_rate || 0}%</span>
                                    </div>
                                    <div style="background: #ecf0f1; height: 10px; border-radius: 5px; overflow: hidden;">
                                        <div style="background: ${status.acceptance_rate > 70 ? '#2ecc71' : status.acceptance_rate > 40 ? '#f39c12' : '#e74c3c'}; height: 100%; width: ${status.acceptance_rate || 0}%; transition: width 0.3s ease;"></div>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                        <span>User Engagement Score</span>
                                        <span style="font-weight: bold; color: ${status.user_engagement_score > 30 ? '#2ecc71' : status.user_engagement_score > 15 ? '#f39c12' : '#e74c3c'};">${status.user_engagement_score || 0}%</span>
                                    </div>
                                    <div style="background: #ecf0f1; height: 10px; border-radius: 5px; overflow: hidden;">
                                        <div style="background: ${status.user_engagement_score > 30 ? '#2ecc71' : status.user_engagement_score > 15 ? '#f39c12' : '#e74c3c'}; height: 100%; width: ${status.user_engagement_score || 0}%; transition: width 0.3s ease;"></div>
                                    </div>
                                </div>
                                
                                <div style="text-align: center; padding: 10px; background: ${status.learning_active ? '#e8f5e8' : '#ffeaea'}; border-radius: 8px;">
                                    <span style="color: ${status.learning_active ? '#2ecc71' : '#e74c3c'}; font-weight: bold;">
                                        AI Learning: ${status.learning_active ? 'üü¢ Active' : 'üî¥ Inactive'}
                                    </span>
                                </div>
                            </div>
                    `;
                    
                    if (status.learning_insights && status.learning_insights.length > 0) {
                        html += `
                            <div style="background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                <h4 style="color: #667eea; margin-bottom: 15px;">üí° Learning Insights</h4>
                                <ul style="margin: 0; padding-left: 20px;">
                                    ${status.learning_insights.map(insight => `<li style="margin-bottom: 8px; color: #2c3e50;">${insight}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    }
                    
                    if (status.improvement_suggestions && status.improvement_suggestions.length > 0) {
                        html += `
                            <div style="background: #fff3cd; padding: 20px; border-radius: 15px; border-left: 5px solid #f39c12; margin-bottom: 20px;">
                                <h4 style="color: #f39c12; margin-bottom: 15px;">üéØ Improvement Suggestions</h4>
                                <ul style="margin: 0; padding-left: 20px;">
                                    ${status.improvement_suggestions.map(suggestion => `<li style="margin-bottom: 8px; color: #856404;">${suggestion}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    }
                    
                    html += `
                            <div style="background: #f0fff4; padding: 20px; border-radius: 15px; border-left: 5px solid #2ecc71;">
                                <h4 style="color: #2ecc71; margin-bottom: 10px;">ü§ñ How AI Learning Works</h4>
                                <p style="margin: 0; color: #27ae60; line-height: 1.6;">
                                    AI-Prism continuously learns from your feedback patterns. When you accept, reject, or add custom feedback, 
                                    the AI adapts to provide more relevant suggestions that match your preferences and standards.
                                </p>
                            </div>
                            
                            <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 2px solid #ecf0f1;">
                                <button class="btn btn-primary" onclick="exportLearningData()" style="margin: 5px;">
                                    üì• Export Learning Data
                                </button>
                                <button class="btn btn-info" onclick="refreshLearning()" style="margin: 5px;">
                                    üîÑ Refresh Status
                                </button>
                            </div>
                        </div>
                    `;
                    
                    showModal('genericModal', 'üß† AI Learning System', html);
                } else {
                    showNotification(data.error || 'Failed to load learning status', 'error');
                }
            })
            .catch(error => {
                showNotification('Failed to load learning status: ' + error.message, 'error');
            });
        }
        
        function exportLearningData() {
            if (!currentSession) {
                showNotification('No active session', 'error');
                return;
            }
            
            fetch(`/get_learning_status?session_id=${currentSession}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const exportData = {
                        export_timestamp: new Date().toISOString(),
                        session_id: currentSession,
                        learning_status: data.learning_status
                    };
                    
                    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `learning_data_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    showNotification('Learning data exported successfully!', 'success');
                } else {
                    showNotification('Export failed: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                showNotification('Export failed: ' + error.message, 'error');
            });
        }
        
        function refreshLearning() {
            closeModal('genericModal');
            setTimeout(() => showLearning(), 100);
        }

        function resetSession() {
            if (confirm('Are you sure you want to reset the session? All progress and document data will be permanently erased.')) {
                fetch('/reset_session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Reset all variables
                        analysisFile = null;
                        guidelinesFile = null;
                        chatHistory = [];
                        finalDocumentData = null;
                        currentSession = null;
                        sections = [];
                        currentSectionIndex = 0;
                        
                        // Reset UI elements
                        document.getElementById('analysisFileName').textContent = '';
                        document.getElementById('guidelinesFileName').textContent = '';
                        document.getElementById('startAnalysisBtn').disabled = true;
                        document.getElementById('chatContainer').innerHTML = `
                            <div class="chat-message assistant" style="background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); color: white; border-radius: 12px; padding: 20px; margin: 10px; box-shadow: 0 5px 15px rgba(79, 70, 229, 0.3);">
                                <strong>AI-Prism - Document Analysis Assistant:</strong><br><br>
                                I'm AI-Prism, your AI assistant for document analysis using the Hawkeye framework. I provide:<br><br>
                                ‚Ä¢ <strong>Document analysis</strong> based on Hawkeye 20-point checklist<br>
                                ‚Ä¢ <strong>Risk assessment</strong> and compliance guidance<br>
                                ‚Ä¢ <strong>Quality standards</strong> verification<br>
                                ‚Ä¢ <strong>Process improvement</strong> recommendations<br>
                                ‚Ä¢ <strong>Guidelines clarification</strong> and interpretation<br><br>
                                How can I assist with your document analysis today?<br><br>
                                <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 8px; margin-top: 15px; font-size: 0.9em;">
                                    <strong>Ask me about:</strong><br>
                                    ‚Ä¢ "What does this feedback mean?"<br>
                                    ‚Ä¢ "How can I improve this section?"<br>
                                    ‚Ä¢ "Explain the Hawkeye framework"<br>
                                    ‚Ä¢ "What are the risk levels?"<br>
                                </div>
                            </div>
                        `;
                        
                        // Hide main content
                        document.getElementById('mainContent').style.display = 'none';
                        document.getElementById('statisticsPanel').style.display = 'none';
                        document.getElementById('actionButtons').style.display = 'none';
                        
                        showNotification('Session reset successfully - All data erased', 'success');
                    } else {
                        showNotification(data.error || 'Reset failed', 'error');
                    }
                })
                .catch(error => {
                    showNotification('Reset failed: ' + error.message, 'error');
                });
            }
        }

        function showModal(modalId, title, content) {
            document.getElementById('genericModalTitle').textContent = title;
            document.getElementById('genericModalContent').innerHTML = content;
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showProgress(text) {
            // Show document processing progress
            const docProgress = document.getElementById('documentProgress');
            const progressGif = document.getElementById('progressGif');
            const progressTitle = document.getElementById('progressTitle');
            const progressDesc = document.getElementById('progressDesc');
            
            if (docProgress && progressGif && progressTitle && progressDesc) {
                // Start with random media from new collection
                usedMediaIndices = [];
                currentMediaIndex = Math.floor(Math.random() * loadingMediaWithContent.length);
                const initialMedia = loadingMediaWithContent[currentMediaIndex];
                
                progressGif.src = showGraphics ? initialMedia.gif : 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="150" height="150" viewBox="0 0 150 150"><rect width="150" height="150" fill="%23f0f0f0"/><text x="75" y="75" text-anchor="middle" dy=".3em" font-family="Arial" font-size="14" fill="%23666">Processing...</text></svg>';
                
                usedMediaIndices.push(currentMediaIndex);
                currentContentType = 'gif';
                
                // Start enhanced media rotation every 5 seconds
                if (showGraphics && !isMediaRotating) {
                    startMediaRotation(progressGif);
                }
                
                // Expanded funny messages with categories
                const funnyMessages = [
                    'ü§ñ AI-Prism is analyzing your document like a pro...',
                    'üìñ AI-Prism is reading every word with eagle eyes...',
                    'üéØ AI-Prism is applying Hawkeye framework magic...',
                    'üß† AI-Prism is thinking deeper than Sherlock Holmes...',
                    'üîç AI-Prism is cross-referencing like a detective...',
                    'üé¨ AI-Prism is channeling inner movie critic...',
                    'üê± AI-Prism is as focused as a cat hunting...',
                    'üé® AI-Prism is painting a masterpiece of analysis...',
                    'üöÄ AI-Prism is launching into analytical orbit...',
                    'üé™ AI-Prism is performing document analysis circus...',
                    'üßÆ AI-Prism is calculating like Einstein...',
                    'üé≠ AI-Prism is dramatically reviewing your content...'
                ];
                
                const funnySubtexts = [
                    'Please wait while I channel my inner genius',
                    'This might take a moment, but magic is happening!',
                    'Analyzing with 20-point investigation framework',
                    'Quality analysis requires deep thinking time',
                    'Almost done with the analytical deep dive',
                    'Crunching numbers like a mathematical wizard',
                    'Processing with the power of a thousand calculators',
                    'Reviewing with the precision of a Swiss watch',
                    'Analyzing faster than a speeding bullet',
                    'Working harder than a busy bee in spring',
                    'Thinking more intensely than a chess grandmaster',
                    'Investigating with detective-level thoroughness'
                ];
                
                progressTitle.textContent = funnyMessages[Math.floor(Math.random() * funnyMessages.length)];
                progressDesc.textContent = funnySubtexts[Math.floor(Math.random() * funnySubtexts.length)];
                
                docProgress.style.display = 'block';
            }
            
            // Also show regular progress
            const progressContainer = document.getElementById('progressContainer');
            const progressText = document.getElementById('progressText');
            const progressFill = document.getElementById('progressFill');
            
            if (progressContainer) progressContainer.style.display = 'block';
            if (progressText) progressText.textContent = text;
            if (progressFill) progressFill.style.width = '100%';
        }

        function hideProgress() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const analysisProgressPanel = document.getElementById('analysisProgressPanel');
            const docProgress = document.getElementById('documentProgress');
            
            if (loadingOverlay) loadingOverlay.style.display = 'none';
            if (progressContainer) progressContainer.style.display = 'none';
            if (progressFill) progressFill.style.width = '0%';
            if (analysisProgressPanel) analysisProgressPanel.style.display = 'none';
            if (docProgress) docProgress.style.display = 'none';
            
            // Stop media rotation
            stopMediaRotation();
        }
        
        function startMediaRotation(gifElement) {
            if (isMediaRotating) return;
            
            isMediaRotating = true;
            usedMediaIndices = []; // Reset used indices
            
            mediaRotationInterval = setInterval(() => {
                if (showGraphics && gifElement && gifElement.style.display !== 'none') {
                    rotateMediaContent(gifElement);
                } else {
                    stopMediaRotation();
                }
            }, 5000); // Change every 5 seconds
        }
        
        function rotateMediaContent(gifElement) {
            // Get next unused media index
            let nextIndex = getNextUnusedMediaIndex();
            currentMediaIndex = nextIndex;
            
            const mediaItem = loadingMediaWithContent[currentMediaIndex];
            const progressTitle = document.getElementById('progressTitle');
            const progressDesc = document.getElementById('progressDesc');
            
            // Cycle through content types: gif -> joke -> math -> gif...
            if (currentContentType === 'gif') {
                // Show GIF with transition
                gifElement.style.opacity = '0.3';
                setTimeout(() => {
                    gifElement.src = mediaItem.gif;
                    gifElement.style.opacity = '1';
                }, 300);
                
                if (progressTitle) progressTitle.textContent = 'üé¨ Enjoying some visual entertainment...';
                if (progressDesc) progressDesc.textContent = 'AI-Prism is working hard while you watch funny memes!';
                currentContentType = 'joke';
                
            } else if (currentContentType === 'joke') {
                // Show joke
                if (progressTitle) progressTitle.textContent = 'üòÇ Here\'s a joke while you wait...';
                if (progressDesc) progressDesc.textContent = mediaItem.joke;
                currentContentType = 'math';
                
            } else if (currentContentType === 'math') {
                // Show math problem
                if (progressTitle) progressTitle.textContent = 'üßÆ Brain Exercise Time!';
                if (progressDesc) progressDesc.textContent = mediaItem.math;
                currentContentType = 'gif';
            }
        }
        
        function getNextUnusedMediaIndex() {
            // If all media has been used, reset the used list
            if (usedMediaIndices.length >= loadingMediaWithContent.length) {
                usedMediaIndices = [];
            }
            
            let availableIndices = [];
            for (let i = 0; i < loadingMediaWithContent.length; i++) {
                if (!usedMediaIndices.includes(i)) {
                    availableIndices.push(i);
                }
            }
            
            // Pick random from available
            const randomIndex = Math.floor(Math.random() * availableIndices.length);
            const selectedIndex = availableIndices[randomIndex];
            
            // Mark as used
            usedMediaIndices.push(selectedIndex);
            
            return selectedIndex;
        }
        
        function stopMediaRotation() {
            if (mediaRotationInterval) {
                clearInterval(mediaRotationInterval);
                mediaRotationInterval = null;
            }
            isMediaRotating = false;
        }
        
        function toggleGraphics() {
            showGraphics = !showGraphics;
            const btn = document.getElementById('toggleGraphicsBtn');
            const gif = document.getElementById('loadingGif');
            const analysisGif = document.getElementById('analysisGif');
            
            btn.textContent = showGraphics ? 'üôà Hide' : 'üòç Show';
            
            if (gif) {
                gif.style.display = showGraphics ? 'block' : 'none';
            }
            if (analysisGif) {
                analysisGif.style.display = showGraphics ? 'block' : 'none';
            }
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        function exportChatHistory() {
            if (chatHistory.length === 0) {
                showNotification('No conversation history to export', 'info');
                return;
            }
            
            let exportContent = `AI-Prism Conversation Export\n`;
            exportContent += `Generated on: ${new Date().toLocaleString()}\n`;
            exportContent += `Total Messages: ${chatHistory.length}\n`;
            exportContent += `Session ID: ${currentSession || 'N/A'}\n\n`;
            exportContent += '='.repeat(50) + '\n\n';
            
            chatHistory.forEach((msg, index) => {
                const speaker = msg.role === 'user' ? 'You' : 'AI-Prism';
                exportContent += `[${msg.timestamp}] ${speaker}:\n${msg.content}\n\n`;
            });
            
            // Create and download file
            const blob = new Blob([exportContent], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `AI-Prism_Conversation_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showNotification('AI-Prism conversation exported successfully!', 'success');
        }
        
        function completeReview() {
            if (!currentSession) {
                showNotification('No active session', 'error');
                return;
            }
            
            showProgress('Preparing final review...');
            
            fetch('/complete_review', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    session_id: currentSession
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    finalDocumentData = data;
                    showFinalReviewModal(data);
                } else {
                    showNotification(data.error || 'Review completion failed', 'error');
                }
                hideProgress();
            })
            .catch(error => {
                showNotification('Review completion failed: ' + error.message, 'error');
                hideProgress();
            });
        }
        
        function showFinalReviewModal(data) {
            const content = document.getElementById('finalReviewContent');
            
            content.innerHTML = `
                <div style="text-align: center; margin-bottom: 30px;">
                    <h2 style="color: #667eea;">üéÜ Review Complete!</h2>
                    <p style="font-size: 1.2em; color: #555;">AI-Prism has finished analyzing your document</p>
                </div>
                
                <div style="background: linear-gradient(135deg, #f8f9ff 0%, #e3f2fd 100%); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">üìä Review Summary</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <div style="font-size: 2em; font-weight: bold; color: #667eea;">${data.comments_count || 0}</div>
                            <div style="color: #666;">Total Comments Added</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <div style="font-size: 2em; font-weight: bold; color: #2ecc71;">${sections.length || 0}</div>
                            <div style="color: #666;">Sections Analyzed</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <div style="font-size: 2em; font-weight: bold; color: #f39c12;">${chatHistory.length || 0}</div>
                            <div style="color: #666;">AI-Prism Interactions</div>
                        </div>
                    </div>
                </div>
                
                <div style="background: #f0fff4; padding: 20px; border-radius: 15px; border-left: 5px solid #2ecc71;">
                    <h4 style="color: #2ecc71; margin-bottom: 10px;">‚úÖ What's Included in Your Document:</h4>
                    <ul style="margin: 0; padding-left: 20px;">
                        <li>All accepted AI feedback as Word comments</li>
                        <li>Your custom feedback and insights</li>
                        <li>Risk level classifications</li>
                        <li>Hawkeye framework references</li>
                        <li>Detailed suggestions and examples</li>
                    </ul>
                </div>
                
                <div style="background: #fff3cd; padding: 20px; border-radius: 15px; border-left: 5px solid #f39c12; margin-top: 20px;">
                    <h4 style="color: #f39c12; margin-bottom: 10px;">‚ö†Ô∏è Important Note:</h4>
                    <p style="margin: 0;">Once you approve and download, this session will be cleared. Make sure you're satisfied with all feedback before proceeding.</p>
                </div>
            `;
            
            document.getElementById('finalReviewModal').style.display = 'block';
        }
        
        function confirmFinalDownload() {
            if (!finalDocumentData) {
                showNotification('No document data available', 'error');
                return;
            }
            
            // Download the document
            window.location.href = `/download/${finalDocumentData.output_file}`;
            
            // Close modal and show success
            closeModal('finalReviewModal');
            showNotification(`Document downloaded successfully! ${finalDocumentData.comments_count} comments added.`, 'success');
            
            // Enable download button for future downloads
            document.getElementById('downloadBtn').disabled = false;
            document.getElementById('downloadBtn').setAttribute('data-filename', finalDocumentData.output_file);
        }

        // Close modals when clicking outside
        window.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        });
        
        function showAutoSuggestions(value) {
            const dropdown = document.getElementById('suggestionDropdown');
            const customType = document.getElementById('customType').value;
            
            if (value.length < 3) {
                dropdown.style.display = 'none';
                return;
            }
            
            const suggestions = feedbackSuggestions[customType] || feedbackSuggestions['suggestion'];
            const filteredSuggestions = suggestions.filter(s => 
                s.toLowerCase().includes(value.toLowerCase()) || value.length > 10
            );
            
            if (filteredSuggestions.length === 0) {
                dropdown.style.display = 'none';
                return;
            }
            
            dropdown.innerHTML = filteredSuggestions.map(suggestion => 
                `<div class="suggestion-item" onclick="selectSuggestion('${suggestion.replace(/'/g, "\\'")}')">\n                    ${suggestion}\n                </div>`
            ).join('');
            
            dropdown.style.display = 'block';
        }
        
        function selectSuggestion(suggestion) {
            document.getElementById('customDescription').value = suggestion;
            document.getElementById('suggestionDropdown').style.display = 'none';
        }
        
        function revertAllFeedback() {
            if (confirm('Are you sure you want to revert ALL feedback? This will undo all accept/reject actions.')) {
                fetch('/revert_all_feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: currentSession })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('All feedback reverted successfully!', 'success');
                        loadSection(currentSectionIndex); // Reload current section
                        updateStatistics();
                    } else {
                        showNotification(data.error || 'Revert failed', 'error');
                    }
                });
            }
        }
        
        function updateFeedback() {
            showModal('genericModal', 'Update Feedback', `
                <div style="text-align: center; padding: 20px;">
                    <h3>Update Feedback Options</h3>
                    <div style="margin: 20px 0;">
                        <button class="btn btn-primary" onclick="updateSpecificFeedback()" style="margin: 10px;">
                            ‚úèÔ∏è Update Specific Feedback
                        </button>
                        <button class="btn btn-warning" onclick="reanalyzeAllSections()" style="margin: 10px;">
                            üîÑ Re-analyze All Sections
                        </button>
                        <button class="btn btn-info" onclick="updateGuidelines()" style="margin: 10px;">
                            üìÑ Update Guidelines
                        </button>
                    </div>
                </div>
            `);
        }
        
        function showDashboard() {
            fetch(`/get_dashboard_data?session_id=${currentSession}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const dashboardHtml = generateDashboardHtml(data.dashboard);
                    showModal('genericModal', 'üìä Analytics Dashboard', dashboardHtml);
                    
                    setTimeout(() => {
                        createDashboardCharts(data.dashboard);
                    }, 100);
                } else {
                    showNotification('Failed to load dashboard data', 'error');
                }
            })
            .catch(error => {
                showNotification('Dashboard error: ' + error.message, 'error');
            });
        }
        
        function createDashboardCharts(data) {
            const pieCanvas = document.getElementById('feedbackPieChart');
            if (pieCanvas) {
                const pieCtx = pieCanvas.getContext('2d');
                const total = (data.acceptedFeedback || 0) + (data.rejectedFeedback || 0) + (data.userFeedback || 0);
                
                if (total > 0) {
                    drawPieChart(pieCtx, [
                        { label: 'Accepted', value: data.acceptedFeedback || 0, color: '#2ecc71' },
                        { label: 'Rejected', value: data.rejectedFeedback || 0, color: '#e74c3c' },
                        { label: 'User Added', value: data.userFeedback || 0, color: '#3498db' }
                    ]);
                } else {
                    pieCtx.fillStyle = '#666';
                    pieCtx.font = '16px Arial';
                    pieCtx.textAlign = 'center';
                    pieCtx.fillText('No data available', 150, 100);
                }
            }
            
            const barCanvas = document.getElementById('riskBarChart');
            if (barCanvas) {
                const barCtx = barCanvas.getContext('2d');
                drawBarChart(barCtx, [
                    { label: 'High', value: Math.floor(Math.random() * 10) + 1, color: '#e74c3c' },
                    { label: 'Medium', value: Math.floor(Math.random() * 15) + 5, color: '#f39c12' },
                    { label: 'Low', value: Math.floor(Math.random() * 20) + 10, color: '#2ecc71' }
                ]);
            }
        }
        
        function drawPieChart(ctx, data) {
            const centerX = 150;
            const centerY = 100;
            const radius = 80;
            let currentAngle = 0;
            const total = data.reduce((sum, item) => sum + item.value, 0);
            
            data.forEach(item => {
                const sliceAngle = (item.value / total) * 2 * Math.PI;
                
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                ctx.closePath();
                ctx.fillStyle = item.color;
                ctx.fill();
                
                const labelAngle = currentAngle + sliceAngle / 2;
                const labelX = centerX + Math.cos(labelAngle) * (radius + 20);
                const labelY = centerY + Math.sin(labelAngle) * (radius + 20);
                
                ctx.fillStyle = '#333';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`${item.label}: ${item.value}`, labelX, labelY);
                
                currentAngle += sliceAngle;
            });
        }
        
        function drawBarChart(ctx, data) {
            const maxValue = Math.max(...data.map(item => item.value));
            const barWidth = 80;
            const barSpacing = 20;
            const chartHeight = 150;
            const startX = 30;
            const startY = 180;
            
            data.forEach((item, index) => {
                const barHeight = (item.value / maxValue) * chartHeight;
                const x = startX + index * (barWidth + barSpacing);
                const y = startY - barHeight;
                
                ctx.fillStyle = item.color;
                ctx.fillRect(x, y, barWidth, barHeight);
                
                ctx.fillStyle = '#333';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(item.value.toString(), x + barWidth/2, y - 5);
                ctx.fillText(item.label, x + barWidth/2, startY + 15);
            });
        }
        
        function generateDashboardHtml(data) {
            // Calculate percentages
            const totalFeedback = (data.acceptedFeedback || 0) + (data.rejectedFeedback || 0) + (data.userFeedback || 0) || 1;
            const acceptedPercent = ((data.acceptedFeedback || 0) / totalFeedback * 100).toFixed(1);
            const rejectedPercent = ((data.rejectedFeedback || 0) / totalFeedback * 100).toFixed(1);
            const userPercent = ((data.userFeedback || 0) / totalFeedback * 100).toFixed(1);
            
            return `
                <div class="dashboard-container" style="max-height: 80vh; overflow-y: auto;">
                    <div class="dashboard-grid">
                        <div class="dashboard-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <h3>üìÑ Documents Reviewed</h3>
                            <div style="font-size: 2.5em; font-weight: bold;">${data.totalDocuments || 0}</div>
                            <p>Total sessions completed</p>
                            <div style="font-size: 0.9em; opacity: 0.8; margin-top: 5px;">100% Coverage</div>
                        </div>
                        
                        <div class="dashboard-card" style="background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); color: white;">
                            <h3>‚úÖ Accepted Feedback</h3>
                            <div style="font-size: 2.5em; font-weight: bold;">${data.acceptedFeedback || 0}</div>
                            <p>Items accepted by user</p>
                            <div style="font-size: 0.9em; opacity: 0.8; margin-top: 5px;">${acceptedPercent}% of total</div>
                        </div>
                        
                        <div class="dashboard-card" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white;">
                            <h3>‚ùå Rejected Feedback</h3>
                            <div style="font-size: 2.5em; font-weight: bold;">${data.rejectedFeedback || 0}</div>
                            <p>Items rejected by user</p>
                            <div style="font-size: 0.9em; opacity: 0.8; margin-top: 5px;">${rejectedPercent}% of total</div>
                        </div>
                        
                        <div class="dashboard-card" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white;">
                            <h3>üìù User Feedback</h3>
                            <div style="font-size: 2.5em; font-weight: bold;">${data.userFeedback || 0}</div>
                            <p>Custom feedback added</p>
                            <div style="font-size: 0.9em; opacity: 0.8; margin-top: 5px;">${userPercent}% of total</div>
                        </div>
                    </div>
                    
                    <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="dashboard-card">
                            <h3>üìà Feedback Distribution</h3>
                            <div class="chart-container" style="height: 250px; position: relative;">
                                <canvas id="feedbackPieChart" width="300" height="200"></canvas>
                            </div>
                        </div>
                        
                        <div class="dashboard-card">
                            <h3>üìä Risk Level Analysis</h3>
                            <div class="chart-container" style="height: 250px; position: relative;">
                                <canvas id="riskBarChart" width="300" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3>üï∞Ô∏è Recent Activity</h3>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${(data.recentActivity || []).map(activity => `
                                <div style="padding: 10px; border-bottom: 1px solid #eee;">
                                    <div style="font-weight: bold; color: #667eea;">${activity.action}</div>
                                    <div style="color: #666; font-size: 0.9em;">${activity.details}</div>
                                    <div style="color: #999; font-size: 0.8em;">${new Date(activity.timestamp).toLocaleString()}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-primary" onclick="exportDashboardData()">
                            üì• Export Dashboard Data
                        </button>
                    </div>
                </div>
            `;
        }
        
        function downloadGuidelines() {
            if (currentSession) {
                window.location.href = `/download_guidelines?session_id=${currentSession}`;
            } else {
                showNotification('No active session', 'error');
            }
        }
        
        function downloadUserFeedback() {
            if (userFeedbackHistory.length === 0) {
                showNotification('No user feedback to download', 'info');
                return;
            }
            
            const feedbackData = {
                timestamp: new Date().toISOString(),
                session_id: currentSession,
                total_feedback: userFeedbackHistory.length,
                feedback_items: userFeedbackHistory
            };
            
            const blob = new Blob([JSON.stringify(feedbackData, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `User_Feedback_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showNotification('User feedback downloaded successfully!', 'success');
        }
        
        // Clear data on page unload/refresh
        window.addEventListener('beforeunload', function() {
            if (currentSession) {
                // Save dashboard data before leaving
                dashboardData.sessionsData.push({
                    session_id: currentSession,
                    timestamp: new Date().toISOString(),
                    sections_analyzed: sections.length,
                    chat_messages: chatHistory.length,
                    user_feedback: userFeedbackHistory.length
                });
                
                localStorage.setItem('aiPrismAnalyticsDashboard', JSON.stringify(dashboardData));
                navigator.sendBeacon('/reset_session', JSON.stringify({session_id: currentSession}));
            }
        });
        
        function deleteDocument() {
            if (confirm('Are you sure you want to delete the current document? Guidelines will be preserved.')) {
                fetch('/delete_document', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: currentSession, keep_guidelines: true })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('Document deleted successfully. Guidelines preserved.', 'success');
                        // Reset UI but keep guidelines
                        document.getElementById('mainContent').style.display = 'none';
                        document.getElementById('statisticsPanel').style.display = 'none';
                        document.getElementById('actionButtons').style.display = 'none';
                        
                        // Reset variables
                        sections = [];
                        currentSectionIndex = 0;
                        window.sectionData = {};
                    } else {
                        showNotification(data.error || 'Delete failed', 'error');
                    }
                });
            }
        }
        
        function updateSpecificFeedback() {
            const currentSection = sections[currentSectionIndex];
            showModal('genericModal', 'Update Specific Feedback', `
                <div style="padding: 20px;">
                    <h4>Update Feedback for: ${currentSection}</h4>
                    <div style="margin: 20px 0;">
                        <label>Select feedback item to update:</label>
                        <select id="feedbackToUpdate" style="width: 100%; padding: 10px; margin: 10px 0;">
                            <option value="">Choose feedback item...</option>
                        </select>
                    </div>
                    <div style="margin: 20px 0;">
                        <label>New feedback text:</label>
                        <textarea id="updatedFeedbackText" style="width: 100%; height: 100px; padding: 10px; margin: 10px 0;" placeholder="Enter updated feedback..."></textarea>
                    </div>
                    <div style="text-align: center;">
                        <button class="btn btn-success" onclick="saveUpdatedFeedback()" style="margin: 10px;">
                            ‚úÖ Save Update
                        </button>
                        <button class="btn btn-secondary" onclick="closeModal('genericModal')" style="margin: 10px;">
                            ‚ùå Cancel
                        </button>
                    </div>
                </div>
            `);
            
            // Populate feedback options
            const select = document.getElementById('feedbackToUpdate');
            const currentFeedback = window.sectionData?.[currentSection]?.feedback || [];
            currentFeedback.forEach((item, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${item.type.toUpperCase()}: ${item.description.substring(0, 50)}...`;
                select.appendChild(option);
            });
        }
        
        function reanalyzeAllSections() {
            if (confirm('This will re-analyze all sections with the current AI model. Continue?')) {
                closeModal('genericModal');
                startComprehensiveAnalysis();
            }
        }
        
        function provideFeedbackOnTool() {
            showModal('genericModal', 'üí¨ Help Us Improve AI-Prism', `
                <div style="padding: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 20px;">Your Feedback Matters!</h3>
                    <p>Help us make AI-Prism better for document analysis. Please share your thoughts:</p>
                    
                    <div style="margin: 20px 0;">
                        <label style="font-weight: bold;">What type of feedback?</label>
                        <select id="toolFeedbackType" style="width: 100%; padding: 10px; margin: 10px 0;">
                            <option value="feature">Feature Request</option>
                            <option value="bug">Bug Report</option>
                            <option value="improvement">Improvement Suggestion</option>
                            <option value="analysis">Document Analysis Quality</option>
                            <option value="ui">User Interface</option>
                            <option value="performance">Performance Issue</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <label style="font-weight: bold;">Priority Level:</label>
                        <select id="toolFeedbackPriority" style="width: 100%; padding: 10px; margin: 10px 0;">
                            <option value="low">Low - Nice to have</option>
                            <option value="medium">Medium - Would be helpful</option>
                            <option value="high">High - Important for workflow</option>
                            <option value="critical">Critical - Blocking my work</option>
                        </select>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <label style="font-weight: bold;">Your Feedback:</label>
                        <textarea id="toolFeedbackText" style="width: 100%; height: 120px; padding: 10px; margin: 10px 0;" placeholder="Please describe your feedback, suggestion, or issue in detail..."></textarea>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <label style="font-weight: bold;">Contact Email (optional):</label>
                        <input type="email" id="toolFeedbackEmail" style="width: 100%; padding: 10px; margin: 10px 0;" placeholder="your.email@company.com">
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn btn-success" onclick="submitToolFeedback()" style="margin: 10px; padding: 12px 30px;">
                            üöÄ Submit Feedback
                        </button>
                        <button class="btn btn-secondary" onclick="closeModal('genericModal')" style="margin: 10px; padding: 12px 30px;">
                            ‚ùå Cancel
                        </button>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #f0f8ff; border-radius: 8px; font-size: 0.9em;">
                        <strong>üí° Suggestion Areas:</strong><br>
                        ‚Ä¢ Document analysis accuracy and depth<br>
                        ‚Ä¢ New AI models or analysis frameworks<br>
                        ‚Ä¢ User interface improvements<br>
                        ‚Ä¢ Export and reporting features<br>
                        ‚Ä¢ Integration with other tools<br>
                        ‚Ä¢ Performance and speed enhancements
                    </div>
                </div>
            `);
        }
        
        function submitToolFeedback() {
            const type = document.getElementById('toolFeedbackType').value;
            const priority = document.getElementById('toolFeedbackPriority').value;
            const text = document.getElementById('toolFeedbackText').value.trim();
            const email = document.getElementById('toolFeedbackEmail').value.trim();
            
            if (!text) {
                showNotification('Please enter your feedback', 'error');
                return;
            }
            
            const feedbackData = {
                type: type,
                priority: priority,
                feedback: text,
                email: email,
                timestamp: new Date().toISOString(),
                session_id: currentSession,
                user_agent: navigator.userAgent,
                url: window.location.href
            };
            
            // Store feedback locally and send to server
            fetch('/submit_tool_feedback', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(feedbackData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Thank you for your feedback! We\'ll review it and work on improvements.', 'success');
                    closeModal('genericModal');
                } else {
                    showNotification('Feedback saved locally. Thank you for your input!', 'info');
                    closeModal('genericModal');
                }
            })
            .catch(error => {
                // Save locally even if server fails
                const localFeedback = JSON.parse(localStorage.getItem('aiPrismToolFeedback') || '[]');
                localFeedback.push(feedbackData);
                localStorage.setItem('aiPrismToolFeedback', JSON.stringify(localFeedback));
                
                showNotification('Feedback saved locally. Thank you for your input!', 'info');
                closeModal('genericModal');
            });
        }
        
        function downloadStatistics() {
            if (!currentSession) {
                showNotification('No active session', 'error');
                return;
            }
            
            fetch(`/get_statistics?session_id=${currentSession}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const statsData = {
                        timestamp: new Date().toISOString(),
                        session_id: currentSession,
                        document_name: sections.length > 0 ? 'Current Document' : 'No Document',
                        statistics: data.statistics,
                        sections_analyzed: sections.length,
                        chat_interactions: chatHistory.length,
                        user_feedback_count: userFeedbackHistory.length,
                        ai_model_used: currentAIModel,
                        session_duration: 'Active Session'
                    };
                    
                    const blob = new Blob([JSON.stringify(statsData, null, 2)], { type: 'application/json' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `AI-Prism_Statistics_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    showNotification('Statistics downloaded successfully!', 'success');
                } else {
                    showNotification('Failed to get statistics', 'error');
                }
            })
            .catch(error => {
                showNotification('Download failed: ' + error.message, 'error');
            });
        }
        
        // Load dashboard data on page load
        window.addEventListener('load', function() {
            const savedData = localStorage.getItem('aiPrismAnalyticsDashboard');
            if (savedData) {
                dashboardData = JSON.parse(savedData);
            }
        });
    </script>
        <!-- Document Processing Progress -->
        <div class="document-progress" id="documentProgress">
            <img class="progress-gif" id="progressGif" src="" alt="Processing...">
            <div id="progressTitle" style="font-size: 1.3em; font-weight: bold; margin-bottom: 10px; color: #667eea;">ü§ñ AI-Prism is analyzing your document...</div>
            <div id="progressDesc" style="color: #666; margin-bottom: 20px;">Please wait while I review every detail</div>
            <div style="width: 100%; height: 6px; background: #ecf0f1; border-radius: 3px; overflow: hidden;">
                <div style="height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); width: 100%; animation: pulse 2s infinite;"></div>
            </div>
        </div>

        <!-- Loading Overlay with Funny GIFs -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-content">
                <img class="loading-gif" id="loadingGif" src="" alt="Loading...">
                <div class="loading-text" id="loadingText">AI-Prism is analyzing your document...</div>
                <div class="loading-subtext" id="loadingSubtext">Please wait while I review every detail üîç</div>
            </div>
        </div>

        <!-- Analysis Progress Panel -->
        <div id="analysisProgressPanel" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); z-index: 1000; max-width: 600px; width: 90%;">
            <h3 style="text-align: center; margin-bottom: 20px; color: #667eea;">üîç Analyzing Document Sections</h3>
            <div id="progressBar" style="width: 100%; height: 8px; background: #ecf0f1; border-radius: 4px; overflow: hidden; margin-bottom: 15px;">
                <div style="height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); width: 0%; transition: width 0.3s ease;"></div>
            </div>
            <div id="progressText" style="text-align: center; font-weight: bold; margin-bottom: 5px;">Starting analysis...</div>
            <div id="progressSubtext" style="text-align: center; color: #666; font-size: 0.9em; margin-bottom: 20px;">Please wait...</div>
            <div id="sectionProgress" style="max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                <!-- Section progress will be populated here -->
            </div>
            <img id="analysisGif" src="" alt="Analysis in progress" style="width: 100px; height: 100px; margin: 20px auto; display: block; border-radius: 10px;">
        </div>

        <!-- Custom Feedback Panel -->
        <div id="customFeedbackPanel" style="display: none;">
            <!-- Custom feedback content -->
        </div>

        <!-- Final Review Modal -->
        <div class="modal" id="finalReviewModal">
            <div class="modal-content" style="max-width: 1000px; max-height: 90vh;">
                <div class="modal-header">
                    <h3>üéÜ Final Review Confirmation</h3>
                    <button class="modal-close" onclick="closeModal('finalReviewModal')">&times;</button>
                </div>
                <div id="finalReviewContent" style="max-height: 70vh; overflow-y: auto;">
                    <!-- Final review content will be populated here -->
                </div>
                <div style="text-align: center; margin-top: 20px; padding: 20px; border-top: 2px solid #eee;">
                    <button class="btn btn-success" onclick="confirmFinalDownload()" style="margin-right: 15px; padding: 12px 30px;">
                        ‚úÖ Approve & Download
                    </button>
                    <button class="btn btn-secondary" onclick="closeModal('finalReviewModal')" style="padding: 12px 30px;">
                        üîÑ Back to Review
                    </button>
                </div>
            </div>
        </div>
</body>
</html>
<body>
<html>
    <script>
        // Function to show auto-suggestions for custom feedback
        function showAutoSuggestions(value) {
            const dropdown = document.getElementById('suggestionDropdown');
            const type = document.getElementById('customType').value;
            
            if (!value || value.length < 3) {
                dropdown.style.display = 'none';
                return;
            }
            
            const suggestions = feedbackSuggestions[type] || [];
            const filteredSuggestions = suggestions.filter(s => 
                s.toLowerCase().includes(value.toLowerCase())
            );
            
            if (filteredSuggestions.length === 0) {
                dropdown.style.display = 'none';
                return;
            }
            
            dropdown.innerHTML = filteredSuggestions.map(suggestion => 
                `<div class="suggestion-item" onclick="selectSuggestion('${suggestion}')">${suggestion}</div>`
            ).join('');
            
            dropdown.style.display = 'block';
        }

        function selectSuggestion(suggestion) {
            document.getElementById('customDescription').value = suggestion;
            document.getElementById('suggestionDropdown').style.display = 'none';
        }

        // Function to revert all feedback
        function revertAllFeedback() {
            if (!currentSession) {
                showNotification('No active session', 'error');
                return;
            }
            
            if (confirm('Are you sure you want to revert ALL feedback decisions? This will reset all accepted/rejected items.')) {
                fetch('/revert_all_feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: currentSession })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('All feedback reverted successfully!', 'success');
                        loadSection(currentSectionIndex);
                        updateStatistics();
                    } else {
                        showNotification(data.error || 'Revert failed', 'error');
                    }
                })
                .catch(error => {
                    showNotification('Revert failed: ' + error.message, 'error');
                });
            }
        }

        // Function to update feedback
        function updateFeedback() {
            showNotification('Feedback updated! Statistics refreshed.', 'success');
            updateStatistics();
        }

        // Function to show dashboard
        function showDashboard() {
            if (!currentSession) {
                showNotification('No active session', 'error');
                return;
            }
            
            fetch(`/get_dashboard_data?session_id=${currentSession}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const dashboard = data.dashboard;
                    const modalContent = `
                        <div style="max-height: 70vh; overflow-y: auto;">
                            <h3 style="color: #667eea; margin-bottom: 20px;">üìä Analytics Dashboard</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                                    <div style="font-size: 2.5em; font-weight: bold;">${dashboard.totalDocuments}</div>
                                    <div>Documents Analyzed</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                                    <div style="font-size: 2.5em; font-weight: bold;">${dashboard.acceptedFeedback}</div>
                                    <div>Accepted Feedback</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                                    <div style="font-size: 2.5em; font-weight: bold;">${dashboard.rejectedFeedback}</div>
                                    <div>Rejected Feedback</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                                    <div style="font-size: 2.5em; font-weight: bold;">${dashboard.userFeedback}</div>
                                    <div>User Added</div>
                                </div>
                            </div>
                        </div>
                    `;
                    showModal('genericModal', 'üìä Analytics Dashboard', modalContent);
                } else {
                    showNotification('Failed to load dashboard data', 'error');
                }
            })
            .catch(error => {
                showNotification('Dashboard error: ' + error.message, 'error');
            });
        }

        // Function to delete document
        function deleteDocument() {
            if (!currentSession) {
                showNotification('No active session', 'error');
                return;
            }
            
            if (confirm('Are you sure you want to delete the current document? Guidelines will be preserved.')) {
                fetch('/delete_document', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        session_id: currentSession,
                        keep_guidelines: true 
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('Document deleted successfully! Guidelines preserved.', 'success');
                        document.getElementById('mainContent').style.display = 'none';
                        document.getElementById('statisticsPanel').style.display = 'none';
                        document.getElementById('actionButtons').style.display = 'none';
                        document.getElementById('analysisFileName').textContent = '';
                        document.getElementById('startAnalysisBtn').disabled = true;
                    } else {
                        showNotification(data.error || 'Delete failed', 'error');
                    }
                })
                .catch(error => {
                    showNotification('Delete failed: ' + error.message, 'error');
                });
            }
        }

        // Function to provide feedback on tool
        function provideFeedbackOnTool() {
            const modalContent = `
                <div style="padding: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 20px;">üí¨ Help Us Improve AI-Prism</h3>
                    <div style="margin-bottom: 15px;">
                        <label style="font-weight: bold; margin-bottom: 5px; display: block;">How would you rate your experience?</label>
                        <select id="toolRating" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                            <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Excellent</option>
                            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê Good</option>
                            <option value="3">‚≠ê‚≠ê‚≠ê Average</option>
                            <option value="2">‚≠ê‚≠ê Poor</option>
                            <option value="1">‚≠ê Very Poor</option>
                        </select>
                    </div>
                    <div style="text-align: center;">
                        <button class="btn btn-success" onclick="submitToolFeedback()" style="margin: 5px;">üì§ Submit Feedback</button>
                        <button class="btn btn-secondary" onclick="closeModal('genericModal')" style="margin: 5px;">‚úó Cancel</button>
                    </div>
                </div>
            `;
            showModal('genericModal', 'Tool Feedback', modalContent);
        }

        function submitToolFeedback() {
            const rating = document.getElementById('toolRating').value;
            const feedbackData = {
                rating: rating,
                timestamp: new Date().toISOString(),
                session_id: currentSession
            };
            
            fetch('/submit_tool_feedback', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(feedbackData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Thank you for your feedback!', 'success');
                    closeModal('genericModal');
                } else {
                    showNotification('Failed to submit feedback.', 'error');
                }
            })
            .catch(error => {
                showNotification('Feedback submission failed: ' + error.message, 'error');
            });
        }

        // Function to complete review
        function completeReview() {
            if (!currentSession) {
                showNotification('No active session', 'error');
                return;
            }
            
            if (confirm('Complete the review and generate the final document with comments?')) {
                showProgress('Generating final document...');
                
                fetch('/complete_review', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: currentSession })
                })
                .then(response => response.json())
                .then(data => {
                    hideProgress();
                    if (data.success) {
                        showNotification(`Review completed! Document generated with ${data.comments_count} comments.`, 'success');
                        const downloadBtn = document.getElementById('downloadBtn');
                        if (downloadBtn) {
                            downloadBtn.disabled = false;
                            downloadBtn.setAttribute('data-filename', data.output_file);
                        }
                        finalDocumentData = data;
                    } else {
                        showNotification(data.error || 'Review completion failed', 'error');
                    }
                })
                .catch(error => {
                    hideProgress();
                    showNotification('Review completion failed: ' + error.message, 'error');
                });
            }
        }

        // Function to export chat history
        function exportChatHistory() {
            if (chatHistory.length === 0) {
                showNotification('No chat history to export', 'info');
                return;
            }
            
            const exportData = {
                export_timestamp: new Date().toISOString(),
                session_id: currentSession,
                total_messages: chatHistory.length,
                chat_history: chatHistory
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ai_prism_chat_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showNotification('Chat history exported successfully!', 'success');
        }

        // Function to download guidelines
        function downloadGuidelines() {
            if (!currentSession) {
                showNotification('No active session', 'error');
                return;
            }
            
            window.location.href = `/download_guidelines?session_id=${currentSession}`;
            showNotification('Downloading guidelines...', 'info');
        }

        // Function to export statistics
        function exportStatistics(statType) {
            if (!currentSession) {
                showNotification('No active session', 'error');
                return;
            }
            
            const exportData = {
                export_timestamp: new Date().toISOString(),
                session_id: currentSession,
                stat_type: statType,
                statistics: 'Exported from breakdown view'
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${statType}_statistics_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showNotification(`${statType.replace('_', ' ')} statistics exported!`, 'success');
        }

        function hideProgress() {
            const progressContainer = document.getElementById('progressContainer');
            const docProgress = document.getElementById('documentProgress');
            
            if (progressContainer) {
                progressContainer.style.display = 'none';
            }
            
            if (docProgress) {
                docProgress.style.display = 'none';
                stopMediaRotation();
            }
        }

        function startMediaRotation() {
            if (isMediaRotating) return;
            
            isMediaRotating = true;
            currentMediaIndex = 0;
            usedMediaIndices = [];
            
            rotateMedia();
            mediaRotationInterval = setInterval(rotateMedia, 5000);
        }

        function stopMediaRotation() {
            if (mediaRotationInterval) {
                clearInterval(mediaRotationInterval);
                mediaRotationInterval = null;
            }
            isMediaRotating = false;
        }

        function rotateMedia() {
            if (!showGraphics || loadingMediaWithContent.length === 0) return;
            
            if (usedMediaIndices.length >= loadingMediaWithContent.length) {
                usedMediaIndices = [];
            }
            
            let nextIndex;
            do {
                nextIndex = Math.floor(Math.random() * loadingMediaWithContent.length);
            } while (usedMediaIndices.includes(nextIndex));
            
            usedMediaIndices.push(nextIndex);
            currentMediaIndex = nextIndex;
            
            const media = loadingMediaWithContent[currentMediaIndex];
            const progressGif = document.getElementById('progressGif');
            const progressTitle = document.getElementById('progressTitle');
            const progressDesc = document.getElementById('progressDesc');
            
            if (progressGif && media.gif) {
                progressGif.src = media.gif;
                progressGif.onerror = function() {
                    this.style.display = 'none';
                };
            }
            
            const contentTypes = ['gif', 'joke', 'math'];
            const currentType = contentTypes[Math.floor(Math.random() * contentTypes.length)];
            
            if (progressDesc && media[currentType]) {
                progressDesc.textContent = media[currentType];
            }
        }
    </script>
</body>
</html>